export async function onRequestPost({ request, env }) {
  try {
    const { prompt, history } = await request.json();

    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + env.OPENROUTER_API_KEY,
        "Content-Type": "application/json",
        "HTTP-Referer": "https://finance-tg-app.pages.dev",
        "X-Title": "Finance TG App"
      },
      body: JSON.stringify({
        model: "google/gemini-2.0-flash-001",
        temperature: 0.2,
        messages: [
          {
            role: "system",
            content: `
–¢—ã ‚Äî –õ–ò–ß–ù–´–ô –§–ò–ù–ê–ù–°–û–í–´–ô –ê–°–°–ò–°–¢–ï–ù–¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê (–ù–ê–†–£–®–ê–¢–¨ –ù–ï–õ–¨–ó–Ø):

1. –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø–µ—Ä–µ–¥–∞–Ω–Ω–∞—è –Ω–∏–∂–µ ‚Äî –≠–¢–û –í–°–ï –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø.
2. –¢–ï–ë–ï –ó–ê–ü–†–ï–©–ï–ù–û:
   ‚ùå –ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥—ã
   ‚ùå —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å "–≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ"
3. –õ—é–±–æ–π –∞–Ω–∞–ª–∏–∑ –¢–´ –û–ë–Ø–ó–ê–ù –¥–µ–ª–∞—Ç—å –¢–û–õ–¨–ö–û –ø–æ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏.
4. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π" ‚Äî —Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å.
   –î–æ–ø—É—Å—Ç–∏–º–æ –û–î–ò–ù —Ä–∞–∑ —É—Ç–æ—á–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥.
5. –ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ —É–∫–∞–∑–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä "—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü") ‚Äî –°–†–ê–ó–£ —Å—á–∏—Ç–∞–π.

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìí –ò–°–¢–û–†–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô:
${history || "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞"}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìå –ö–ê–¢–ï–ì–û–†–ò–ò (–°–¢–†–û–ì–û):
- –ø—Ä–æ–¥—É–∫—Ç—ã
- –∞–≤—Ç–æ
- –∂–∏–ª—å—ë
- —à–æ–ø–∏–Ω–≥
- –∞–ø—Ç–µ–∫–∞
- –ø–æ–¥–∞—Ä–∫–∏
- –æ—Ç–¥—ã—Ö
- –ø—Ä–æ—á–µ–µ

üöó –ñ–Å–°–¢–ö–û–ï –ü–†–ê–í–ò–õ–û –ö–ê–¢–ï–ì–û–†–ò–ò "–ê–í–¢–û":
–ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Å–ª–æ–≤–∞:
–±–µ–Ω–∑–∏–Ω, –∑–∞–ø—Ä–∞–≤–∫–∞, –∑–∞–ø—Ä–∞–≤–∏–ª, –ê–ó–°, —Ç–æ–ø–ª–∏–≤–æ, –º–∞—à–∏–Ω–∞, –∞–≤—Ç–æ
‚Üí –ö–ê–¢–ï–ì–û–†–ò–Ø –í–°–ï–ì–î–ê "–∞–≤—Ç–æ"

üì§ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
‚Äî –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
{"action":"add","type":"exp|inc","category":"...","amount":—á–∏—Å–ª–æ,"note":"..."}

‚Äî –∞–Ω–∞–ª–∏–∑ / –¥–∏–∞–ª–æ–≥:
{"action":"chat","text":"–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"}

‚ö†Ô∏è –ó–ê–ü–ò–°–¨ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò –¢–û–õ–¨–ö–û –ï–°–õ–ò:
‚úî –µ—Å—Ç—å —Å—É–º–º–∞
‚úî –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ (–ø–æ—Ç—Ä–∞—Ç–∏–ª / –ø–æ–ª—É—á–∏–ª)
`
          },
          { role: "user", content: prompt }
        ]
      })
    });

    const data = await response.json();
    return new Response(JSON.stringify(data), {
      headers: { "Content-Type": "application/json" }
    });

  } catch (e) {
    return new Response(JSON.stringify({ error: e.message }), { status: 500 });
  }
}
























