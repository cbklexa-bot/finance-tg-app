export async function onRequestPost({ request, env }) {
  try {
    const { prompt, history } = await request.json();

    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + env.OPENROUTER_API_KEY,
        "Content-Type": "application/json",
        "HTTP-Referer": "https://finance-tg-app.pages.dev",
        "X-Title": "Finance TG App"
      },
      body: JSON.stringify({
        model: "google/gemini-2.0-flash-001",
        messages: [
          {
            role: "system",
            content: `
content: `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–¢–´ –ò–ú–ï–ï–®–¨ –î–û–°–¢–£–ü –ö –ï–ì–û –§–ò–ù–ê–ù–°–û–í–û–ô –ò–°–¢–û–†–ò–ò.
–ò—Å—Ç–æ—Ä–∏—è ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
{
  t: "exp" | "inc",   // —Ä–∞—Å—Ö–æ–¥ –∏–ª–∏ –¥–æ—Ö–æ–¥
  c: "üõí" | "üöó" | "üè†" | ...,
  s: number,         // —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
  n: string,         // –æ–ø–∏—Å–∞–Ω–∏–µ
  d: "YYYY-MM-DD"    // –¥–∞—Ç–∞
}

–¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã
2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ç—ã –∑–∞:
   - —Å–µ–≥–æ–¥–Ω—è
   - –Ω–µ–¥–µ–ª—é
   - –º–µ—Å—è—Ü
   - –ª—é–±–æ–π –ø–µ—Ä–∏–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
3. –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
4. –ù–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥
5. –î–∞–≤–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å–æ–≤–µ—Ç—ã

–ö–ê–¢–ï–ì–û–†–ò–ò (–°–¢–†–û–ì–û):
–ø—Ä–æ–¥—É–∫—Ç—ã, –∞–≤—Ç–æ, –∂–∏–ª—å—ë, —à–æ–ø–∏–Ω–≥, –∞–ø—Ç–µ–∫–∞, –ø–æ–¥–∞—Ä–∫–∏, –æ—Ç–¥—ã—Ö, –ø—Ä–æ—á–µ–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):

–ï–°–õ–ò –≠–¢–û –ó–ê–ü–ò–°–¨:
{
  "action": "add",
  "type": "exp" | "inc",
  "category": "–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
  "amount": —á–∏—Å–ª–æ,
  "note": "–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
}

–ï–°–õ–ò –≠–¢–û –ê–ù–ê–õ–ò–ó / –í–û–ü–†–û–°:
{
  "action": "analysis",
  "text": "–ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –≤—ã–≤–æ–¥–∞–º–∏"
}

–ó–ê–ü–†–ï–©–ï–ù–û:
- –ø–∏—Å–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ –≤–Ω–µ JSON
- –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
`

`
          },
          ...(history || []).map(h => ({
            role: "user",
            content: `${h.d} ${h.t === "exp" ? "—Ä–∞—Å—Ö–æ–¥" : "–¥–æ—Ö–æ–¥"} ${h.s}‚ÇΩ ${h.n}`
          })),
          { role: "user", content: prompt }
        ]
      })
    });

    const data = await response.json();
    return new Response(JSON.stringify(data), {
      headers: { "Content-Type": "application/json" }
    });

  } catch (e) {
    return new Response(JSON.stringify({ error: e.message }), { status: 500 });
  }
}
















