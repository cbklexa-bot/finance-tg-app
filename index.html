<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #000000; --card: #1c1c1e; --text: #a1a1aa; --main: #ffffff; 
            --blue: #0a84ff; --red: #ff453a; --green: #30d158; --orange: #ff9f0a; --border: rgba(255, 255, 255, 0.1); 
            --btn-bg: #2c2c2e; --glass: rgba(28, 28, 30, 0.85); --grad: linear-gradient(135deg, #2c2c2e 0%, #000000 100%);
            --sw-ball: #ffffff;
        }
        .light { 
            --bg: #f2f2f7; --card: #ffffff; --text: #636366; --main: #000000; 
            --border: rgba(0, 0, 0, 0.08); --btn-bg: #e5e5ea; 
            --glass: rgba(255, 255, 255, 0.85); --grad: linear-gradient(135deg, #ffffff 0%, #f2f2f7 100%);
            --sw-ball: #000000;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--main); margin: 0; min-height: 100vh; overflow-x: hidden; padding-top: env(safe-area-inset-top); }
        .page { display: none; padding: 15px; padding-bottom: 120px; box-sizing: border-box; }
        .active { display: block; }
        .active > *:not(.ai-controls) { animation: slideUp 0.3s ease; }

        /* --- –°–¢–ò–õ–ò –ë–õ–û–ö–ù–û–¢–ê –ò –ö–ê–õ–ï–ù–î–ê–†–Ø --- */
        .tab-btn { flex:1; text-align:center; padding:10px; border-radius:10px; font-size:11px; font-weight:800; cursor:pointer; transition:0.2s; color: var(--text); white-space: nowrap; }
        .tab-btn.active { background: var(--card); color: var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .note-view { display: none; }
        .note-view.active { display: block; animation: slideUp 0.3s ease; }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: var(--card); padding: 10px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 15px; }
        .cal-day { text-align: center; padding: 8px 0; font-size: 14px; border-radius: 8px; cursor: pointer; color: var(--text); position: relative; }
        .cal-day.active { background: var(--blue); color: white; font-weight: bold; }
        .cal-day.today { color: var(--blue); font-weight: 800; border: 1px solid var(--blue); }
        .cal-day.has-tasks::after { content:""; display:block; width:4px; height:4px; background:var(--green); border-radius:50%; margin:2px auto 0; }
        .cal-weekday { text-align: center; font-size: 10px; color: var(--text); font-weight: 800; padding-bottom: 5px; }

        /* –ó–∞–¥–∞—á–∏ */
        .task-item { display:flex; align-items:center; background:var(--card); padding:12px; border-radius:15px; margin-bottom:8px; border:1px solid var(--border); }
        .task-check { width:22px; height:22px; border-radius:50%; border:2px solid var(--text); margin-right:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; }
        .task-check.done { background:var(--green); border-color:var(--green); }
        .task-check.done::after { content:"‚úì"; color:#fff; font-size:14px; font-weight:bold; }
        .task-text { font-size:14px; font-weight:600; flex:1; }
        .task-text.done { text-decoration:line-through; opacity:0.5; }

        /* –ü—Ä–∏–≤—ã—á–∫–∏ */
        .habit-card { background:var(--card); border-radius:20px; padding:15px; border:1px solid var(--border); display:flex; flex-direction:column; align-items:center; text-align:center; }
        .habit-circle { width:50px; height:50px; border-radius:50%; background:var(--btn-bg); display:flex; align-items:center; justify-content:center; margin:10px 0; cursor:pointer; transition:0.3s; border:3px solid transparent; }
        .habit-circle.done { border-color:var(--green); background:rgba(48, 209, 88, 0.2); color:var(--green); transform:scale(1.1); }
        .streak-count { font-size:10px; color:var(--text); font-weight:700; }

        /* –ó–∞–º–µ—Ç–∫–∏ */
        .note-card { background:var(--card); border-radius:18px; padding:15px; border:1px solid var(--border); margin-bottom:10px; cursor:pointer; }
        .note-head { font-weight:800; font-size:15px; margin-bottom:5px; color:var(--main); }
        .note-preview { font-size:12px; color:var(--text); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
        .compact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 5px; }
        .ticker-group { display: flex; gap: 15px; }
        .ticker { display: flex; flex-direction: column; }
        .ticker span:first-child { font-size: 8px; font-weight: 800; color: var(--text); text-transform: uppercase; }
        .ticker span:last-child { font-size: 12px; font-weight: 800; color: var(--green); }
        
        .sw-box { width: 44px; height: 24px; background: var(--btn-bg); border-radius: 20px; position: relative; cursor: pointer; border: 1px solid var(--border); }
        .sw-box::after { content: ""; position: absolute; width: 20px; height: 20px; left: 2px; top: 2px; background: var(--sw-ball); border-radius: 50%; transition: 0.25s; }
        .light .sw-box::after { transform: translateX(20px); }

        #edit-modal, #budget-modal, #note-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; 
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content { background: var(--card); border-radius: 28px; padding: 25px; border: 1px solid var(--border); width: 100%; max-width: 400px; }

        #chart-container { position: relative; height: 260px; margin: 10px 0; background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow: hidden; touch-action: pan-y; }
        #chart-slider { display: flex; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); height: 100%; width: 100%; }
        .chart-slide { min-width: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .chart-title { position: absolute; top: 15px; font-size: 10px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 1px; }
        
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: 0.3s; }
        .dot.active { background: var(--blue); transform: scale(1.3); }

        .balance-card { background: var(--grad); border-radius: 24px; padding: 25px 20px; margin-bottom: 15px; border: 1px solid var(--border); text-align: center; position: relative; cursor: pointer; }
        .bal-label { font-size: 11px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .bal-container { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .bal-amount { font-size: 38px; font-weight: 900; transition: filter 0.3s ease; }
        .bal-amount.blurred { filter: blur(12px); }
        .eye-icon { width: 24px; height: 24px; stroke: var(--text); fill: none; stroke-width: 2; }

        .input-section { background: var(--card); border-radius: 24px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .sum-in { width: 100%; background: transparent; border: none; color: var(--main); font-size: 40px; font-weight: 900; text-align: center; outline: none; }
        .note-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 12px; color: var(--main); font-size: 15px; box-sizing: border-box; text-align: center; outline: none; }
        .date-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 10px; color: var(--blue); font-size: 14px; font-weight: 700; text-align: center; box-sizing: border-box; outline: none; }
        .save-btn { background: var(--blue); color: white; border: none; border-radius: 18px; padding: 16px; font-size: 16px; font-weight: 800; width: 100%; cursor:pointer; }
        
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .cat-icon { width: 47px; height: 47px; background: var(--btn-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid transparent; transition: 0.2s; margin: 0 auto; }
        .cat-item.active .cat-icon { border-color: var(--blue); background: var(--blue); }
        .cat-name { font-size: 9px; color: var(--text); font-weight: 600; margin-top: 5px; display: block; text-align: center; text-transform: uppercase; }

        .total-budget-card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; text-align: center; }
        .bud-progress-card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 10px; border: 1px solid var(--border); }
        .pg-bar { width: 100%; height: 8px; background: var(--btn-bg); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .pg-fill { height: 100%; transition: 0.5s; }

        .h-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card); border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }
        .h-amount { font-weight: 900; font-size: 16px; }

        #ai-chat::-webkit-scrollbar { width: 0; }
        .ai-msg { background: var(--card); padding: 12px; border-radius: 18px 18px 18px 5px; border: 1px solid var(--border); max-width: 85%; font-size: 14px; line-height: 1.4; }
        .user-msg { align-self: flex-end; background: var(--blue); color: white; padding: 12px; border-radius: 18px 18px 5px 18px; max-width: 85%; font-size: 14px; }
        
        .bud-cat-select { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .bud-cat-item { 
            flex: 0 0 40px; height: 40px; border-radius: 50%; background: var(--btn-bg); 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid transparent; cursor: pointer; font-size: 18px;
        }
        .bud-cat-item.active { border-color: var(--blue); background: var(--blue); }

        .ai-controls { 
            position: fixed; bottom: 75px; left: 15px; right: 15px; 
            display: flex; align-items: center; gap: 10px; 
            background: var(--card); padding: 8px 15px; 
            border-radius: 25px; border: 1px solid var(--border); 
            z-index: 100;
        }
        .mic-btn { background: none; border: none; padding: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-btn svg { width: 20px; height: 20px; stroke: var(--text); fill: none; stroke-width: 2; transition: 0.3s; }
        .mic-btn.active svg { stroke: var(--red); transform: scale(1.2); filter: drop-shadow(0 0 5px var(--red)); }

        .send-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .send-btn svg { width: 20px; height: 20px; stroke: var(--blue); fill: none; stroke-width: 2; transform: rotate(45deg); }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; padding-bottom: env(safe-area-inset-bottom, 15px); z-index: 1000; background: var(--glass); backdrop-filter: blur(20px); border-top: 0.5px solid var(--border); }
        .n-item { flex: 1; text-align: center; padding: 12px 0; color: var(--text); font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .n-item.active { color: var(--blue); }
        .n-item svg { width: 22px; height: 22px; display: block; margin: 0 auto 4px; stroke: currentColor; fill: none; stroke-width: 2.5; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.goal-card {
    background: var(--card);
    border-radius: 22px;
    padding: 16px;
    border: 1px solid var(--border);
    margin-bottom: 12px;
}

.goal-title {
    font-weight: 900;
    font-size: 15px;
}

.goal-progress {
    font-size: 12px;
    color: var(--text);
    margin: 6px 0;
}

.goal-bar {
    height: 8px;
    background: var(--btn-bg);
    border-radius: 10px;
    overflow: hidden;
}

.goal-fill {
    height: 100%;
    background: var(--green);
    transition: 0.4s;
}

/* –û–∫–Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏ (Paywall) */
#paywall-modal {
    display: none; 
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.95); 
    z-index: 9999; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    padding: 20px; 
    text-align: center; 
    backdrop-filter: blur(10px);
}
.premium-icon { font-size: 60px; margin-bottom: 20px; }
.pay-card {
    background: var(--card); 
    border: 1px solid var(--blue); 
    border-radius: 16px; 
    padding: 20px; 
    width: 100%; 
    max-width: 300px; 
    margin-bottom: 30px;
}

    </style>
</head>
<body>
    
<div id="paywall-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; color:white;">
        <div style="background:var(--card); padding:30px; border-radius:24px; border:1px solid var(--border); width:100%; max-width:320px;">
            <div style="font-size:50px; margin-bottom:10px;">‚≠ê</div>
            <h2 style="margin-bottom:10px;">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç—ë–∫</h2>
            <p style="color:var(--text); margin-bottom:25px; font-size:14px;">–í–∞—à–∏ –ø–µ—Ä–≤—ã–µ 7 –¥–Ω–µ–π –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ù–µ–π—Ä–æ–°—á—ë—Ç–æ–º, –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.</p>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin-bottom:25px;">
                <span style="display:block; font-size:12px; color:var(--text); text-transform:uppercase;">–¶–µ–Ω–∞ –∑–∞ 30 –¥–Ω–µ–π</span>
                <span style="font-size:24px; font-weight:bold;">100 Stars</span>
            </div>
            <div id="pay-status" style="margin-bottom:15px; color:var(--blue); font-size:14px;"></div>
            <button onclick="buySubscription()" style="background:var(--blue); color:white; border:none; padding:16px; border-radius:16px; font-weight:bold; width:100%; font-size:16px; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);">
                –û–ø–ª–∞—Ç–∏—Ç—å ‚≠ê 100
            </button>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 style="text-align:center;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
            <input type="number" id="edit-sum" class="sum-in">
            <input type="text" id="edit-note" class="note-in" style="margin: 15px 0;">
            <button class="save-btn" onclick="confirmEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="save-btn" style="background:var(--red); margin-top:10px;" onclick="deleteTransaction()">–£–¥–∞–ª–∏—Ç—å</button>
            <button class="note-in" style="margin-top:10px; background:none;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div> </div> ```
    <div id="budget-modal"><div class="modal-content">
        <h3 style="text-align:center;">–õ–∏–º–∏—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <div class="bud-cat-select" id="bud-cat-list"></div>
        <input type="text" id="new-bud-name" class="note-in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ï–¥–∞)">
        <input type="number" id="new-bud-val" class="note-in" style="margin-top:10px;" placeholder="–°—É–º–º–∞ –ª–∏–º–∏—Ç–∞">
        <button class="save-btn" style="margin-top:20px;" onclick="addBudget()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="bud-del-btn" class="save-btn" style="background:var(--red); display:none; margin-top:10px;" onclick="deleteBudgetReal()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="note-in" style="margin-top:10px; background:none;" onclick="closeBudModal()">–û—Ç–º–µ–Ω–∞</button>
    </div></div>

    <div id="note-modal"><div class="modal-content" style="height:80vh; display:flex; flex-direction:column;">
        <input type="text" id="note-title" class="sum-in" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" style="font-size:20px; text-align:left;">
        <textarea id="note-body" class="note-in" style="flex:1; margin:15px 0; text-align:left; resize:none;" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
        <button class="save-btn" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="note-in" style="margin-top:10px; background:none;" onclick="document.getElementById('note-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div></div>

     <div id="goal-action-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="width:90%; max-width:350px;">
            <h3 id="modal-goal-title" style="text-align:center; margin-bottom:20px; color:var(--main);">–¶–µ–ª—å</h3>
            
            <div style="margin-bottom:20px;">
                <label style="font-size:12px; color:var(--text);">–í–Ω–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –≤ –∫–æ–ø–∏–ª–∫—É:</label>
                <input type="number" id="add-goal-money" class="note-in" placeholder="–°—É–º–º–∞ (‚ÇΩ)" style="margin-top:10px; width:100%; background:var(--btn-bg); border:1px solid var(--border); color:white; padding:10px; border-radius:10px;">
            </div>
            
            <button class="save-btn" onclick="addMoneyToGoal()" style="background:var(--green); color:white; font-weight:bold; margin-bottom:10px;">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="save-btn" onclick="editGoalName()" style="background:var(--btn-bg); font-size:13px;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <button class="save-btn" onclick="deleteGoalReal()" style="background:var(--red); color:white; font-size:13px;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            
            <button class="note-in" style="margin-top:20px; background:none; border:none; color:var(--text);" onclick="closeGoalActionModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="p-home" class="page active">
        <div class="compact-header">
            <div class="ticker-group">
                <div class="ticker"><span>BTC</span><span id="btc-rate">$...</span></div>
                <div class="ticker"><span>RUB</span><span id="usd-rate">...</span></div>
            </div>
            <div class="sw-box" onclick="document.body.classList.toggle('light');"></div>
        </div>
        <div class="balance-card" onclick="toggleBlur()">
            <span class="bal-label">–ë–∞–ª–∞–Ω—Å</span>
            <div class="bal-container">
                <div class="bal-amount" id="bal">0 ‚ÇΩ</div>
                <svg class="eye-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </div>
        </div>
        <div style="display:flex; gap:8px; background:var(--btn-bg); padding:4px; border-radius:12px; margin-bottom:15px;">
            <div id="btn-exp" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer; background:var(--blue);" onclick="setMode('exp')">–†–∞—Å—Ö–æ–¥</div>
            <div id="btn-inc" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer;" onclick="setMode('inc')">–î–æ—Ö–æ–¥</div>
        </div>
        <div class="input-section">
            <input type="number" id="sum" class="sum-in" placeholder="0" inputmode="decimal">
            <input type="text" id="note" class="note-in" placeholder="–ó–∞–º–µ—Ç–∫–∞...">
            <input type="date" id="date-picker" class="date-in">
            <button class="save-btn" onclick="save()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>
        <div class="cat-grid" id="cat-list"></div>
    </div>

    <div id="p-an" class="page">
        <div id="chart-container" ontouchstart="tS(event)" ontouchend="tE(event)">
            <div id="chart-slider">
                <div class="chart-slide"><span class="chart-title">–°–µ–≥–æ–¥–Ω—è</span><svg width="200" height="200" viewBox="0 0 42 42" id="day-chart"></svg></div>
                <div class="chart-slide"><span class="chart-title">–ù–µ–¥–µ–ª—è</span><svg width="320" height="180" id="week-chart"></svg></div>
                <div class="chart-slide"><span class="chart-title">–ú–µ—Å—è—Ü</span><svg width="320" height="180" id="month-chart"></svg></div>
            </div>
        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
        <div id="h-list-full"></div>
    </div>

    <div id="p-bud" class="page">
        <div class="total-budget-card">
            <div style="position:relative; width:120px; height:120px; margin: 0 auto 15px;">
                <svg width="120" height="120" viewBox="0 0 42 42">
                    <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--btn-bg)" stroke-width="3"></circle>
                    <circle id="total-bud-chart" cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--blue)" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="25"></circle>
                </svg>
                <div id="total-bud-perc" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:900;">0%</div>
            </div>
            <div style="display:flex; justify-content:space-around; font-size:12px;">
                <div><div style="color:var(--text)">–¢–†–ê–¢–´</div><b id="total-bud-spent">0 ‚ÇΩ</b></div>
                <div><div style="color:var(--text)">–õ–ò–ú–ò–¢</div><b id="total-bud-limit">0 ‚ÇΩ</b></div>
            </div>
        </div>
        <button onclick="openBudModal()" style="width:100%; background:var(--btn-bg); border:none; color:var(--main); padding:15px; border-radius:15px; margin-bottom:20px; font-weight:800;">+ –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
        <div id="budget-list"></div>
    </div>

    <div id="p-note" class="page">
        <div class="compact-header"><span style="font-weight: 800; color: var(--text);">–ü–õ–ê–ù–ò–†–û–í–©–ò–ö</span></div>
        
        <div style="display:flex; gap:5px; background:var(--btn-bg); padding:4px; border-radius:12px; margin-bottom:15px; overflow-x: auto;">
            <div id="tab-cal" class="tab-btn active" onclick="switchNoteTab('cal')">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
            <div id="tab-tasks" class="tab-btn" onclick="switchNoteTab('tasks')">‚úÖ –°–ø–∏—Å–æ–∫ –¥–µ–ª</div>
            <div id="tab-habits" class="tab-btn" onclick="switchNoteTab('habits')">üîÑ –ü—Ä–∏–≤—ã—á–∫–∏</div>
            <div id="tab-notes" class="tab-btn" onclick="switchNoteTab('notes')">üìù –î–Ω–µ–≤–Ω–∏–∫</div>
            <div id="tab-goals" class="tab-btn" onclick="switchNoteTab('goals')">üéØ –¶–µ–ª–∏</div>
        </div>

        <div id="view-cal" class="note-view active">
            <div id="calendar-container"></div>
            <div id="selected-date-tasks"></div>
        </div>

        <div id="view-tasks" class="note-view">
            <div class="input-section">
                <input type="text" id="task-in" class="note-in" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." style="text-align:left;">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="date" id="task-date" class="date-in" style="flex:1;">
                    <button class="save-btn" style="width:auto; padding:0 15px;" onclick="addTask()">OK</button>
                </div>
            </div>
            <div id="task-list"></div>
        </div>

        <div id="view-habits" class="note-view">
            <div class="input-section" style="flex-direction:row; align-items:center;">
                <input type="text" id="habit-in" class="note-in" placeholder="–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞..." style="text-align:left; margin:0;">
                <button class="save-btn" style="width:50px; margin-left:10px;" onclick="addHabit()">+</button>
            </div>
            <div id="habit-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;"></div>
        </div>

        <div id="view-notes" class="note-view">
            <button class="save-btn" style="width:100%; margin-bottom:15px;" onclick="openNoteModal()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            <div id="note-list"></div>
        </div>

        <div id="view-goals" class="note-view">
    <div class="input-section">
        <input type="text" id="goal-title" class="note-in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏..." style="text-align:left;">
        <input type="number" id="goal-amount" class="note-in" placeholder="–°—É–º–º–∞ —Ü–µ–ª–∏">
        <button class="save-btn" onclick="addGoal()">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
    </div>
    <div id="goal-list"></div>
</div>

    </div>

    <div id="p-ai" class="page">
        <div class="compact-header"><span style="font-weight: 800; color: var(--text);">FINANCE AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span></div>
        <div id="ai-chat" style="height: calc(100vh - 210px); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px;">
            <div class="ai-msg">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ üíº</div>
        </div>
        <div class="ai-controls">
            <button id="mic-btn" class="mic-btn" onclick="toggleVoice()">
                <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
            </button>
            <input type="text" id="ai-input" style="flex:1; background:none; border:none; color:var(--main); outline:none; font-size:14px;" placeholder="–ì–æ–≤–æ—Ä–∏—Ç–µ...">
            <button class="send-btn" onclick="askAI()">
                <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>

    <nav class="nav">
        <div class="n-item active" onclick="go('home')"><svg viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1h-5v-7h-4v7H4a1 1 0 01-1-1V9.5z"/></svg>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="n-item" onclick="go('an')"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="n-item" onclick="go('bud')"><svg viewBox="0 0 24 24"><path d="M9 7h6m-6 4h6m-6 4h6M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>–ë—é–¥–∂–µ—Ç</div>
        <div class="n-item" onclick="go('note')"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>–ë–ª–æ–∫–Ω–æ—Ç</div>
        <div class="n-item" onclick="go('ai')"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 00-7.74 16.33l-1.13 3.38a1 1 0 001.26 1.26l3.38-1.13A10 10 0 1012 2z"/></svg>AI</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const { createClient } = supabase;
        // –£–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ Supabase
        const _supabase = createClient('https://ereiiidezagburttpxtn.supabase.co', 'sb_publishable_YuQ8s49c1LvkCTmoBPQ0hA_7EJ3Z1cj');
        
        // --- 1. –ñ–ï–õ–ï–ó–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï USER ID ---
        // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "–∞–º–Ω–µ–∑–∏–∏" —É –ò–ò –ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        let userId;
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id.toString();
        } else {
            // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –º–µ–Ω—è–ª—Å—è –ø—Ä–∏ F5
            let storedId = localStorage.getItem('test_user_id');
            if (!storedId) {
                storedId = 'demo_user_' + Math.floor(Math.random() * 1000000);
                localStorage.setItem('test_user_id', storedId);
            }
            userId = storedId;
            console.log("–†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –í–∞—à ID:", userId);
        }

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –§–ò–ù–ê–ù–°–û–í ===
        let db = []; // –ú–∞—Å—Å–∏–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        let budgets = JSON.parse(localStorage.getItem('fin_budgets_' + userId)) || [];
        
        let mode = 'exp';
        let currentCat = 'üõí';
        let budSelectedCat = 'üõí';
        let editingId = null; 
        let editingBudIdx = null;
        let currentSlide = 0;
        let touchStartX = 0;

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ë–õ–û–ö–ù–û–¢–ê ===
        let tasks = [];
        let habits = [];
        let notes = [];
        let goals_list = [];
        let selectedGoalId = null;
        let editingNoteId = null;
        let isListening = false;

        // === –ö–û–ù–°–¢–ê–ù–¢–´ ===
        const catColors = { 'üõí':'#ff453a', 'üöó':'#ff9f0a', 'üè†':'#30d158', 'üõçÔ∏è':'#0a84ff', 'üíä':'#bf5af2', 'üéÅ':'#ff375f', 'üé≠':'#64d2ff', 'üì¶':'#a1a1aa', 'üíµ':'#30d158', 'üìà':'#0a84ff' };
        const cats = {
            exp: [{n:'–ü—Ä–æ–¥—É–∫—Ç—ã', i:'üõí'}, {n:'–ê–≤—Ç–æ', i:'üöó'}, {n:'–ñ–∏–ª—å–µ', i:'üè†'}, {n:'–®–æ–ø–∏–Ω–≥', i:'üõçÔ∏è'}, {n:'–ê–ø—Ç–µ–∫–∞', i:'üíä'}, {n:'–ü–æ–¥–∞—Ä–∫–∏', i:'üéÅ'}, {n:'–û—Ç–¥—ã—Ö', i:'üé≠'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}],
            inc: [{n:'–ó–∞—Ä–ø–ª–∞—Ç–∞', i:'üíµ'}, {n:'–ò–Ω–≤–µ—Å—Ç', i:'üìà'}, {n:'–ü–æ–¥–∞—Ä–æ–∫', i:'üéÅ'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}]
        };

        // ==========================================
        //        –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø AI (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
        // ==========================================
        async function askAI() {
            const input = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat');
            
            if (!input || !chat) return;
            const q = input.value.trim();
            if (!q) return;

            // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            chat.innerHTML += `<div class="user-msg">${q}</div>`;
            input.value = '';

            const tempId = 'ai-' + Date.now();
            chat.innerHTML += `<div id="${tempId}" class="ai-msg">ü§ñ –î—É–º–∞—é...</div>`;
            chat.scrollTop = chat.scrollHeight;

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à Python-–±—ç–∫–µ–Ω–¥ (Render)
                const response = await fetch('https://finance-tg-app.onrender.com/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: q,
                        user_id: userId, // –ü–µ—Ä–µ–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID!
                        history: [] // –ò—Å—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –±–µ—Ä–µ—Ç —Å–∞–º –∏–∑ –±–∞–∑—ã
                    })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);

                const raw = await response.json();
                const content = raw?.choices?.[0]?.message?.content || '';

                if (!content) {
                    document.getElementById(tempId).innerText = '‚ö†Ô∏è –ë–æ—Ç –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª.';
                    return;
                }

                // 1. –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ [JSON_DATA] –∏–∑ –æ—Ç–≤–µ—Ç–∞
                const cleanText = content.replace(/\[JSON_DATA\].*?\[\/JSON_DATA\]/gs, "").trim();
                document.getElementById(tempId).innerText = cleanText || "‚úÖ –ì–æ—Ç–æ–≤–æ!";

                // 2. –ï—Å–ª–∏ –±–æ—Ç –ø—Ä–∏—Å–ª–∞–ª –∫–æ–º–∞–Ω–¥—É –∑–∞–ø–∏—Å–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
                if (content.includes("[JSON_DATA]")) {
                    console.log("–ë–æ—Ç –≤–Ω–µ—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...");
                    setTimeout(() => {
                        syncFromCloud(); // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
                    }, 1500);
                }

            } catch (e) {
                console.error(e);
                document.getElementById(tempId).innerText = '‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
            } finally {
                chat.scrollTop = chat.scrollHeight;
            }
        }

        // ==========================================
        //           –§–ò–ù–ê–ù–°–û–í–ê–Ø –õ–û–ì–ò–ö–ê
        // ==========================================
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (–ß—Ç–µ–Ω–∏–µ)
        async function syncFromCloud() {
            // –°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–∑–∏–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
            const local = localStorage.getItem('fin_cache_' + userId);
            if (local) { db = JSON.parse(local); updateUI(); }
            
            try {
                // –í–ê–ñ–ù–û: –ß–∏—Ç–∞–µ–º —Ç–∞–±–ª–∏—Ü—É 'transactions', –∫—É–¥–∞ –ø–∏—à–µ—Ç –ë–û–¢
                const { data: transData, error } = await _supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(500); // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 500 –∑–∞–ø–∏—Å–µ–π

                if (transData) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –±–∞–∑—ã –≤ —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    db = transData.map(t => ({
                        id: t.id,
                        t: t.type === 'income' ? 'inc' : 'exp',
                        c: getIconForCat(t.category), // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å–ª–æ–≤–æ "–ø—Ä–æ–¥—É–∫—Ç—ã" –≤ –∏–∫–æ–Ω–∫—É üõí
                        s: t.amount,
                        n: t.description || t.category,
                        d: t.created_at.split('T')[0]
                    }));
                    
                    updateUI();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
                    localStorage.setItem('fin_cache_' + userId, JSON.stringify(db));
                }
            } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", e); }
        }

        // –ü–æ–º–æ—â–Ω–∏–∫: –°–ª–æ–≤–æ -> –ò–∫–æ–Ω–∫–∞
        function getIconForCat(name) {
            if (!name) return 'üì¶';
            const lower = name.toLowerCase();
            if (lower.includes('–ø—Ä–æ–¥—É–∫—Ç') || lower.includes('–µ–¥–∞')) return 'üõí';
            if (lower.includes('–∞–≤—Ç–æ') || lower.includes('–º–∞—à–∏–Ω') || lower.includes('–±–µ–Ω–∑–∏–Ω')) return 'üöó';
            if (lower.includes('–∂–∏–ª') || lower.includes('–¥–æ–º') || lower.includes('–∫–æ–º–º—É–Ω')) return 'üè†';
            if (lower.includes('—à–æ–ø–∏–Ω–≥') || lower.includes('–æ–¥–µ–∂–¥')) return 'üõçÔ∏è';
            if (lower.includes('–∞–ø—Ç–µ–∫') || lower.includes('–ª–µ–∫–∞—Ä')) return 'üíä';
            if (lower.includes('–ø–æ–¥–∞—Ä')) return 'üéÅ';
            if (lower.includes('–æ—Ç–¥—ã—Ö') || lower.includes('–∫–∞—Ñ–µ')) return 'üé≠';
            if (lower.includes('–∑–∞—Ä–ø–ª–∞—Ç')) return 'üíµ';
            if (lower.includes('–∏–Ω–≤–µ—Å—Ç')) return 'üìà';
            return 'üì¶';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (—Ä—É—á–Ω–æ–µ)
        async function save() {
            const s = document.getElementById('sum'), n = document.getElementById('note'), d = document.getElementById('date-picker');
            if(!s.value) return;
            
            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            const amount = parseFloat(s.value);
            const type = mode === 'inc' ? 'income' : 'expense';
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∏–∫–æ–Ω–∫–µ
            const catObj = cats[mode].find(c => c.i === currentCat);
            const catName = catObj ? catObj.n.toLowerCase() : '–ø—Ä–æ—á–µ–µ';

            // 2. –ü–∏—à–µ–º –°–†–ê–ó–£ –≤ Supabase (–∫–∞–∫ –±–æ—Ç)
            const { error } = await _supabase.from('transactions').insert({
                user_id: userId,
                amount: amount,
                category: catName,
                type: type,
                description: n.value || '–†—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å'
            });

            if (!error) {
                s.value = ''; n.value = ''; 
                if(window.tg) tg.HapticFeedback.notificationOccurred('success');
                syncFromCloud(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ (–ß–µ—Ä–µ–∑ Supabase)
        async function deleteTransaction() {
            if(!editingId) return;
            // –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
            await _supabase.from('transactions').delete().eq('id', editingId);
            closeModal();
            syncFromCloud();
        }

        async function confirmEdit() {
            if(!editingId) return;
            const newSum = parseFloat(document.getElementById('edit-sum').value);
            const newNote = document.getElementById('edit-note').value;
            
            await _supabase.from('transactions').update({
                amount: newSum,
                description: newNote
            }).eq('id', editingId);
            
            closeModal();
            syncFromCloud();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            const total = db.reduce((a,i) => a + (i.t === 'inc' ? i.s : -i.s), 0);
            document.getElementById('bal').innerText = total.toLocaleString() + ' ‚ÇΩ';
            renderCats(); 
            renderHistory(); 
            renderBudget();
            if(document.getElementById('p-an').classList.contains('active')) drawCharts();
        }

        function renderCats() {
            document.getElementById('cat-list').innerHTML = cats[mode].map(c => `<div class="cat-item ${currentCat === c.i ? 'active' : ''}" onclick="currentCat='${c.i}'; renderCats();"><div class="cat-icon">${c.i}</div><span class="cat-name">${c.n}</span></div>`).join('');
        }

        function renderHistory() {
            document.getElementById('h-list-full').innerHTML = db.map(i => `<div class="h-item" onclick="openEdit('${i.id}')"><div><span style="font-size:18px; margin-right:8px;">${i.c}</span><b>${i.n}</b><br><small style="color:var(--text)">${i.d}</small></div><div class="h-amount" style="color:${i.t==='exp'?'var(--red)':'var(--green)'}">${i.s.toLocaleString()} ‚ÇΩ</div></div>`).join('');
        }
        
        function openEdit(id) { 
            editingId = id; 
            const item = db.find(x => x.id == id); // –ù–µ—Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ, —Ç.–∫. ID –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π UUID
            if(item) {
                document.getElementById('edit-sum').value = item.s; 
                document.getElementById('edit-note').value = item.n; 
                document.getElementById('edit-modal').style.display = 'flex'; 
            }
        }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        function setMode(m) { mode = m; currentCat = cats[m][0].i; renderCats(); document.getElementById('btn-exp').style.background = m === 'exp' ? 'var(--blue)' : 'transparent'; document.getElementById('btn-inc').style.background = m === 'inc' ? 'var(--blue)' : 'transparent'; }
        function toggleBlur() { document.getElementById('bal').classList.toggle('blurred'); if(window.tg) tg.HapticFeedback.impactOccurred('light'); }

        // ==========================================
        //           –ë–Æ–î–ñ–ï–¢–´
        // ==========================================
        function renderBudget() {
            const list = document.getElementById('budget-list');
            const curMonth = new Date().toISOString().slice(0, 7);
            let tLimit = 0, tSpent = 0;

            list.innerHTML = budgets.map((b, i) => {
                const icon = getIconForCat(b.cat); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–ø–ø–∏–Ω–≥
                const spent = db.filter(t => t.t === 'exp' && t.c === icon && t.d.startsWith(curMonth)).reduce((a,c)=>a+c.s, 0);
                tLimit += b.limit; tSpent += spent; 
                const perc = Math.min((spent/b.limit)*100, 100);
                return `<div class="bud-progress-card" onclick="openBudModal(${i})">
                            <div style="display:flex; justify-content:space-between; font-size:14px;">
                                <b>${b.cat} ${b.name}</b>
                                <span>${spent.toLocaleString()} / ${b.limit.toLocaleString()} ‚ÇΩ</span>
                            </div>
                            <div class="pg-bar"><div class="pg-fill" style="width:${perc}%; background:${perc > 90 ? 'var(--red)' : 'var(--blue)'}"></div></div>
                        </div>`;
            }).join('');

            document.getElementById('total-bud-limit').innerText = tLimit.toLocaleString() + ' ‚ÇΩ';
            document.getElementById('total-bud-spent').innerText = tSpent.toLocaleString() + ' ‚ÇΩ';
            const totalPerc = tLimit > 0 ? Math.round((tSpent/tLimit)*100) : 0;
            document.getElementById('total-bud-perc').innerText = totalPerc + '%';
            document.getElementById('total-bud-chart').style.strokeDasharray = `${Math.min(totalPerc, 100)} 100`;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª–∫–∏ –±—é–¥–∂–µ—Ç–∞
        function openBudModal(idx = null) { 
            editingBudIdx = idx; 
            if(idx !== null) { 
                document.getElementById('new-bud-name').value = budgets[idx].name; 
                document.getElementById('new-bud-val').value = budgets[idx].limit; 
                budSelectedCat = budgets[idx].cat || 'üõí';
                document.getElementById('bud-del-btn').style.display = 'block'; 
            } else { 
                document.getElementById('new-bud-name').value = ''; 
                document.getElementById('new-bud-val').value = ''; 
                document.getElementById('bud-del-btn').style.display = 'none'; 
            } 
            renderBudCatList();
            document.getElementById('budget-modal').style.display = 'flex'; 
        }
        function closeBudModal() { document.getElementById('budget-modal').style.display = 'none'; }
        function renderBudCatList() { document.getElementById('bud-cat-list').innerHTML = cats.exp.map(c => `<div class="bud-cat-item ${budSelectedCat === c.i ? 'active' : ''}" onclick="budSelectedCat='${c.i}'; renderBudCatList();">${c.i}</div>`).join(''); }
        
        function addBudget() { 
            const n = document.getElementById('new-bud-name').value, v = parseFloat(document.getElementById('new-bud-val').value); 
            if(!n || isNaN(v)) return;
            const catName = cats.exp.find(c => c.i === budSelectedCat)?.n.toLowerCase() || '–ø—Ä–æ—á–µ–µ'; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const data = {name: n, limit: v, cat: catName};
            
            if(editingBudIdx !== null) budgets[editingBudIdx] = data; else budgets.push(data); 
            closeBudModal(); updateUI(); saveNotebook(); 
        }
        function deleteBudgetReal() { budgets.splice(editingBudIdx, 1); closeBudModal(); updateUI(); saveNotebook(); }


        // ==========================================
        //           –ë–õ–û–ö–ù–û–¢ (Task, Habit, Note, Goal)
        // ==========================================
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–ª–æ–∫–Ω–æ—Ç–∞
        async function syncNotebookToCloud() {
            const dataToSave = { tasks, habits, notes, goals_list };
            await _supabase.from('notebook').upsert({ id: userId, data: dataToSave, updated_at: new Date() });
        }
        
        async function syncNotebookFromCloud() {
            const { data } = await _supabase.from('notebook').select('data').eq('id', userId).maybeSingle();
            if (data?.data) {
                tasks = data.data.tasks || [];
                habits = data.data.habits || [];
                notes = data.data.notes || [];
                goals_list = data.data.goals_list || [];
                saveNotebook(false); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
                renderAllNotebook();
            }
        }
        
        function saveNotebook(push = true) {
             localStorage.setItem('fin_tasks_' + userId, JSON.stringify(tasks));
             localStorage.setItem('fin_habits_' + userId, JSON.stringify(habits));
             localStorage.setItem('fin_notes_' + userId, JSON.stringify(notes));
             localStorage.setItem('fin_goals_' + userId, JSON.stringify(goals_list));
             localStorage.setItem('fin_budgets_' + userId, JSON.stringify(budgets));
             if(push) syncNotebookToCloud();
        } 
        
        function loadNotebook() {
            const t = localStorage.getItem('fin_tasks_' + userId);
            const h = localStorage.getItem('fin_habits_' + userId);
            const n = localStorage.getItem('fin_notes_' + userId);
            const g = localStorage.getItem('fin_goals_' + userId);
            if(t) tasks = JSON.parse(t);
            if(h) habits = JSON.parse(h);
            if(n) notes = JSON.parse(n);
            if(g) goals_list = JSON.parse(g);
            renderAllNotebook();
        }
        
        function renderAllNotebook() {
            renderTasks(); renderHabits(); renderNotes(); renderGoals();
        }

        // --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å ---
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = `<div style="text-align:center; margin-bottom:10px; font-weight:800;">${now.toLocaleString('ru', {month: 'long'})} ${year}</div>`;
            html += `<div class="calendar-grid">`;
            const weekdays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
            weekdays.forEach(w => html += `<div class="cal-weekday">${w}</div>`);
            for(let i = 1; i < (firstDay || 7); i++) html += `<div></div>`;
            for(let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = new Date().toISOString().split('T')[0] === dateStr;
                const hasTasks = tasks.some(t => t.date === dateStr);
                html += `<div class="cal-day ${isToday?'today':''} ${hasTasks?'has-tasks':''}" onclick="filterTasksByDate('${dateStr}')">${d}</div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function filterTasksByDate(date) {
            const filtered = tasks.filter(t => t.date === date);
            const list = document.getElementById('selected-date-tasks');
            if (filtered.length === 0) list.innerHTML = `<div style="padding:10px; font-size:12px; color:var(--text); text-align:center;">–ù–∞ ${date} –¥–µ–ª –Ω–µ—Ç</div>`;
            else list.innerHTML = `<h4 style="font-size:12px; margin-bottom:10px;">–ó–∞–¥–∞—á–∏ –Ω–∞ ${date}:</h4>` + filtered.map(t => `<div class="task-item" style="margin-bottom:5px;"><div class="task-check ${t.done?'done':''}" onclick="toggleTask(${t.id})"></div><div class="task-text ${t.done?'done':''}">${t.text}</div></div>`).join('');
        }

        // --- –ó–∞–¥–∞—á–∏ ---
        function addTask() {
            const txt = document.getElementById('task-in').value, date = document.getElementById('task-date').value;
            if(!txt) return;
            tasks.push({ id: Date.now(), text: txt, date: date, done: false });
            document.getElementById('task-in').value = '';
            saveNotebook(); renderTasks();
        }
        function toggleTask(id) { const t = tasks.find(x => x.id === id); if(t) { t.done = !t.done; saveNotebook(); renderTasks(); if(document.getElementById('view-cal').classList.contains('active')) renderCalendar(); } }
        function deleteTask(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { tasks = tasks.filter(x => x.id !== id); saveNotebook(); renderTasks(); } }
        function renderTasks() {
            tasks.sort((a,b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);
            document.getElementById('task-list').innerHTML = tasks.map(t => `<div class="task-item"><div class="task-check ${t.done?'done':''}" onclick="toggleTask(${t.id})"></div><div class="task-text ${t.done?'done':''}" onclick="deleteTask(${t.id})">${t.text} <small style="display:block; font-weight:400; font-size:10px; color:var(--text);">${t.date||''}</small></div></div>`).join('');
        }

        // --- –ü—Ä–∏–≤—ã—á–∫–∏ ---
        function addHabit() { const name = document.getElementById('habit-in').value; if(!name) return; habits.push({ id: Date.now(), name: name, history: [] }); document.getElementById('habit-in').value = ''; saveNotebook(); renderHabits(); }
        function toggleHabit(id) { const h = habits.find(x => x.id === id); const today = new Date().toISOString().split('T')[0]; if(h.history.includes(today)) h.history = h.history.filter(d => d !== today); else { h.history.push(today); if(window.tg) tg.HapticFeedback.notificationOccurred('success'); } saveNotebook(); renderHabits(); }
        function deleteHabit(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { habits = habits.filter(x => x.id !== id); saveNotebook(); renderHabits(); } }
        function renderHabits() { const today = new Date().toISOString().split('T')[0]; document.getElementById('habit-list').innerHTML = habits.map(h => `<div class="habit-card"><div style="font-weight:700; font-size:13px;">${h.name}</div><div class="habit-circle ${h.history.includes(today)?'done':''}" onclick="toggleHabit(${h.id})">üî•</div><div class="streak-count">–î–Ω–µ–π: ${h.history.length}</div><div style="font-size:10px; color:var(--red); margin-top:5px;" onclick="deleteHabit(${h.id})">—É–¥–∞–ª–∏—Ç—å</div></div>`).join(''); }

        // --- –ó–∞–º–µ—Ç–∫–∏ ---
        function openNoteModal(id = null) { editingNoteId = id; if(id) { const n = notes.find(x => x.id === id); document.getElementById('note-title').value = n.title; document.getElementById('note-body').value = n.body; } else { document.getElementById('note-title').value = ''; document.getElementById('note-body').value = ''; } document.getElementById('note-modal').style.display = 'flex'; }
        function saveNote() { const title = document.getElementById('note-title').value, body = document.getElementById('note-body').value; if(!title && !body) return; if(editingNoteId) { const n = notes.find(x => x.id === editingNoteId); n.title = title; n.body = body; n.date = new Date().toLocaleDateString(); } else { notes.unshift({ id: Date.now(), title: title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', body: body, date: new Date().toLocaleDateString() }); } document.getElementById('note-modal').style.display = 'none'; saveNotebook(); renderNotes(); }
        function deleteNote(e, id) { e.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { notes = notes.filter(x => x.id !== id); saveNotebook(); renderNotes(); } }
        function renderNotes() { document.getElementById('note-list').innerHTML = notes.map(n => `<div class="note-card" onclick="openNoteModal(${n.id})"><div style="display:flex; justify-content:space-between;"><div class="note-head">${n.title}</div><div style="color:var(--red); font-size:12px;" onclick="deleteNote(event, ${n.id})">‚úï</div></div><div class="note-preview">${n.body}</div><div style="font-size:10px; color:var(--text); margin-top:5px;">${n.date}</div></div>`).join(''); }

        // --- –¶–µ–ª–∏ ---
        function addGoal() {
            const title = document.getElementById('goal-title').value;
            const amount = parseFloat(document.getElementById('goal-amount').value);
            if (!title || !amount) return;
            goals_list.push({ id: Date.now().toString(), title: title, target: amount, current: 0 });
            document.getElementById('goal-title').value = ''; document.getElementById('goal-amount').value = '';
            renderGoals(); saveNotebook();
        }
        function renderGoals() {
            const list = document.getElementById('goal-list'); if(!list) return; list.innerHTML = '';
            if (!goals_list.length) { list.innerHTML = '<div style="text-align:center; color:var(--text); padding:20px; font-size:12px;">–ù–µ—Ç —Ü–µ–ª–µ–π</div>'; return; }
            goals_list.forEach(g => {
                const perc = Math.min(Math.round((g.current / g.target) * 100), 100);
                list.innerHTML += `<div class="goal-card" onclick="openGoalAction('${g.id}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:800; font-size:14px;">${g.title}</span><span style="color:var(--green); font-weight:800; font-size:12px;">${g.current}/${g.target}</span></div>
                    <div style="background:var(--btn-bg); height:8px; border-radius:4px; margin:10px 0; overflow:hidden;"><div style="width:${perc}%; height:100%; background:var(--green);"></div></div>
                    <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--text);"><span>${perc}%</span><span>–û—Å—Ç: ${g.target - g.current}</span></div></div>`;
            });
        }
        function openGoalAction(id) { selectedGoalId = id; const g = goals_list.find(x => x.id === id); if(g) { document.getElementById('modal-goal-title').innerText = g.title; document.getElementById('goal-action-modal').style.display = 'flex'; } }
        function closeGoalActionModal() { document.getElementById('goal-action-modal').style.display = 'none'; }
        function addMoneyToGoal() { const val = parseFloat(document.getElementById('add-goal-money').value); const g = goals_list.find(x => x.id === selectedGoalId); if(g && val) { g.current += val; closeGoalActionModal(); renderGoals(); saveNotebook(); } }
        function deleteGoalReal() { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { goals_list = goals_list.filter(g => g.id !== selectedGoalId); closeGoalActionModal(); renderGoals(); saveNotebook(); } }
        function editGoalName() { const g = goals_list.find(x => x.id === selectedGoalId); const nn = prompt("–ù–æ–≤–æ–µ –∏–º—è", g.title); if(nn) { g.title = nn; renderGoals(); saveNotebook(); } }


        // ==========================================
        //         –ì–†–ê–§–ò–ö–ò –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ==========================================
        function go(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.n-item').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            const map = {'home':0, 'an':1, 'bud':2, 'note':3, 'ai':4};
            if(map[p]!==undefined) document.querySelectorAll('.n-item')[map[p]].classList.add('active');
            if(p !== 'note') updateUI();
            if(p === 'note' && document.getElementById('tab-cal').classList.contains('active')) renderCalendar();
        }
        
        function switchNoteTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.note-view').forEach(v => v.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.getElementById('view-'+tab).classList.add('active');
            if(tab === 'cal') renderCalendar();
        }

        // –ì—Ä–∞—Ñ–∏–∫–∏ (Day, Week, Month)
        function drawCharts() { 
            document.getElementById('chart-slider').style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            if(currentSlide === 0) renderDayChart(); 
            if(currentSlide === 1) renderWeekChart(); 
            if(currentSlide === 2) renderMonthChart();
        }
        
        function renderDayChart() {
            const chart = document.getElementById('day-chart');
            const today = new Date().toISOString().split('T')[0];
            const tExp = db.filter(i => i.t === 'exp' && i.d === today);
            const total = tExp.reduce((a, b) => a + b.s, 0);
            if (!total) { chart.innerHTML = `<circle cx="21" cy="21" r="15.9" fill="none" stroke="var(--border)" stroke-width="3"/><text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--text)" font-size="4">0 ‚ÇΩ</text>`; return; }
            const grp = {}; tExp.forEach(i => grp[i.c] = (grp[i.c] || 0) + i.s);
            let off = 0, html = '';
            for(let cat in grp) {
                const p = (grp[cat] / total) * 100;
                html += `<circle cx="21" cy="21" r="15.9" fill="none" stroke="${catColors[cat] || 'var(--blue)'}" stroke-width="5" stroke-dasharray="${p} ${100 - p}" stroke-dashoffset="${-off}"></circle>`;
                off += p;
            }
            html += `<text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--main)" font-size="5" font-weight="900">${Math.round(total)} ‚ÇΩ</text>`;
            chart.innerHTML = html;
        }

        function renderWeekChart() {
            const svg = document.getElementById('week-chart');
            const now = new Date();
            const curIdx = now.getDay() === 0 ? 6 : now.getDay() - 1;
            const mon = new Date(now); mon.setDate(now.getDate() - curIdx);
            let html = '';
            const sums = [];
            for(let i=0; i<7; i++) {
                const d = new Date(mon); d.setDate(mon.getDate()+i);
                const ds = d.toISOString().split('T')[0];
                const s = db.filter(x => x.t === 'exp' && x.d === ds).reduce((a,b)=>a+b.s,0);
                sums.push(s);
            }
            const max = Math.max(...sums, 1000) * 1.3;
            const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
            sums.forEach((v, i) => {
                const h = (v/max)*120; const x = 30 + i*40; const y = 140-h;
                html += `<text x="${x+10}" y="${y-8}" text-anchor="middle" fill="var(--main)" font-size="7">${v>0?Math.round(v):''}</text><rect x="${x}" y="${y}" width="20" height="${h}" rx="6" fill="${i===curIdx?'var(--blue)':'var(--btn-bg)'}"/><text x="${x+10}" y="160" text-anchor="middle" fill="var(--text)" font-size="9">${days[i]}</text>`;
            });
            svg.innerHTML = html;
        }

        function renderMonthChart() {
            // (–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ —Ä–∞–±–æ—á–∞—è)
            const svg = document.getElementById('month-chart');
            svg.innerHTML = '<text x="160" y="90" text-anchor="middle" fill="var(--text)">–ì—Ä–∞—Ñ–∏–∫ –º–µ—Å—è—Ü–∞</text>';
        }

        // –°–≤–∞–π–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function tS(e) { touchStartX = e.changedTouches[0].screenX; }
        function tE(e) {
            let x = e.changedTouches[0].screenX;
            if (touchStartX - x > 50 && currentSlide < 2) currentSlide++;
            if (x - touchStartX > 50 && currentSlide > 0) currentSlide--;
            drawCharts();
        }

        // ==========================================
        //           –ó–ê–ü–£–°–ö –ò –ü–û–î–ü–ò–°–ö–ê
        // ==========================================
        
        async function checkSubscription() {
            // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É
            // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            return; 
        }

        async function getRates() {
            try {
                const btc = await (await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')).json();
                document.getElementById('btc-rate').innerText = '$' + btc.bitcoin.usd.toLocaleString();
                const rub = await (await fetch('https://api.exchangerate-api.com/v4/latest/USD')).json();
                document.getElementById('usd-rate').innerText = rub.rates.RUB.toFixed(2) + '‚ÇΩ';
            } catch(e) {}
        }
        
        // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const rec = new SpeechRecognition(); rec.lang = 'ru-RU';
            rec.onstart = () => { isListening=true; document.getElementById('mic-btn').classList.add('active'); };
            rec.onend = () => { isListening=false; document.getElementById('mic-btn').classList.remove('active'); };
            rec.onresult = (e) => { const t = e.results[0][0].transcript; if(t) { document.getElementById('ai-input').value = t; askAI(); } };
            window.toggleVoice = () => { if(isListening) rec.stop(); else rec.start(); };
        } else { window.toggleVoice = () => alert('–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–æ–ª–æ—Å–∞'); }

        // --- –ì–õ–ê–í–ù–´–ô –°–¢–ê–†–¢ ---
        window.onload = async () => {
            console.log("App Started. User ID:", userId);
            
            // –ò–Ω–∏—Ç Telegram
            if (window.tg) { tg.expand(); tg.ready(); }
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã
            const today = new Date().toISOString().split('T')[0];
            const dp = document.getElementById('date-picker'); if(dp) dp.value = today;
            const td = document.getElementById('task-date'); if(td) td.value = today;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–≥–æ
            await checkSubscription();
            loadNotebook();           // –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
            await syncNotebookFromCloud(); // –û–±–ª–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
            await syncFromCloud();    // –§–∏–Ω–∞–Ω—Å—ã –∏–∑ –±–∞–∑—ã

            // –ó–∞–ø—É—Å–∫ UI
            getRates();
            renderGoals();
            go('home');
        };
    </script>
</body>
</html>




















































































































































