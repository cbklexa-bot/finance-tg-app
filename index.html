<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #000000; --card: #1c1c1e; --text: #a1a1aa; --main: #ffffff; 
            --blue: #0a84ff; --red: #ff453a; --green: #30d158; --orange: #ff9f0a; --border: rgba(255, 255, 255, 0.1); 
            --btn-bg: #2c2c2e; --glass: rgba(28, 28, 30, 0.85); --grad: linear-gradient(135deg, #2c2c2e 0%, #000000 100%);
            --sw-ball: #ffffff;
        }
        .light { 
            --bg: #f2f2f7; --card: #ffffff; --text: #636366; --main: #000000; 
            --border: rgba(0, 0, 0, 0.08); --btn-bg: #e5e5ea; 
            --glass: rgba(255, 255, 255, 0.85); --grad: linear-gradient(135deg, #ffffff 0%, #f2f2f7 100%);
            --sw-ball: #000000;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--main); margin: 0; min-height: 100vh; overflow-x: hidden; }
        .page { display: none; padding: 15px; padding-bottom: 120px; }
        .active { display: block; animation: slideUp 0.4s ease; }

        #edit-modal, #budget-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; 
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content { 
            background: var(--card); width: 100%; max-width: 400px; border-radius: 28px; 
            padding: 25px; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--glass); backdrop-filter: blur(20px); border-bottom: 0.5px solid var(--border); }
        .ticker { display: flex; flex-direction: column; }
        .ticker span:first-child { font-size: 8px; font-weight: 800; color: var(--text); text-transform: uppercase; }
        .ticker span:last-child { font-size: 12px; font-weight: 800; color: var(--green); }
        .sw-box { width: 44px; height: 24px; background: var(--btn-bg); border-radius: 20px; position: relative; cursor: pointer; }
        .sw-box::after { content: ""; position: absolute; width: 20px; height: 20px; left: 2px; top: 2px; background: var(--sw-ball); border-radius: 50%; transition: 0.25s; }
        .light .sw-box::after { transform: translateX(20px); }
        
        #chart-container { position: relative; height: 240px; margin: 10px 0; background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow: hidden; touch-action: pan-y; }
        #chart-slider { display: flex; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); height: 100%; }
        .chart-slide { min-width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 10px; }
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: 0.3s; }
        .dot.active { background: var(--blue); transform: scale(1.3); }

        .balance-card { background: var(--grad); border-radius: 24px; padding: 25px 20px; margin-bottom: 15px; border: 1px solid var(--border); text-align: center; position: relative; cursor: pointer; }
        .bal-container { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .bal-amount { font-size: 38px; font-weight: 900; transition: filter 0.3s ease; }
        .bal-amount.blurred { filter: blur(12px); }
        .eye-icon { width: 24px; height: 24px; stroke: var(--text); fill: none; stroke-width: 2; transition: 0.2s; }

        .input-section { background: var(--card); border-radius: 24px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .sum-in { width: 100%; background: transparent; border: none; color: var(--main); font-size: 40px; font-weight: 900; text-align: center; outline: none; }
        .note-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 12px; color: var(--main); font-size: 15px; box-sizing: border-box; text-align: center; outline: none; }
        .date-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 10px; color: var(--blue); font-size: 14px; font-weight: 700; text-align: center; box-sizing: border-box; outline: none; }
        .save-btn { background: var(--blue); color: white; border: none; border-radius: 18px; padding: 16px; font-size: 16px; font-weight: 800; width: 100%; cursor:pointer; }
        .del-btn { background: var(--red); color: white; border: none; border-radius: 18px; padding: 12px; font-size: 14px; font-weight: 700; width: 100%; margin-top: 10px; cursor:pointer; }
        
        .total-budget-card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; text-align: center; }
        .bud-progress-card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer; }
        .pg-bar { width: 100%; height: 8px; background: var(--btn-bg); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .pg-fill { height: 100%; transition: 0.5s; }

        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .cat-icon { width: 52px; height: 52px; background: var(--btn-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; border: 2px solid transparent; transition: 0.2s; margin: 0 auto; }
        .cat-item.active .cat-icon { border-color: var(--blue); background: var(--blue); }
        .cat-name { font-size: 10px; color: var(--text); font-weight: 600; margin-top: 6px; display: block; text-align: center; }

        .h-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card); border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer; }
        .h-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .h-icon-box { font-size: 24px; min-width: 32px; text-align: center; }
        .h-details { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
        .h-title-row { display: flex; align-items: center; gap: 8px; }
        .h-cat-name { font-weight: 800; font-size: 15px; color: var(--main); }
        .h-date { font-size: 11px; color: var(--text); font-weight: 600; }
        .h-note { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-amount { font-weight: 900; font-size: 16px; white-space: nowrap; margin-left: 10px; }

        .nav { position: fixed; bottom: 0; width: 100%; background: var(--glass); backdrop-filter: blur(30px); display: flex; border-top: 0.5px solid var(--border); padding-bottom: env(safe-area-inset-bottom, 15px); }
        .n-item { flex: 1; text-align: center; padding: 12px 0; color: var(--text); font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .n-item.active { color: var(--blue); }
        .n-item svg { width: 22px; height: 22px; display: block; margin: 0 auto 4px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: var(--blue); z-index: 3000; display: none; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader"></div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
            <input type="number" id="edit-sum" class="sum-in" style="font-size:30px; margin-bottom:15px;">
            <input type="text" id="edit-note" class="note-in" style="margin-bottom:20px;">
            <button class="save-btn" onclick="confirmEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="del-btn" onclick="deleteTransaction()">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            <button class="note-in" style="margin-top:10px; background:none; color:var(--text);" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="budget-modal">
        <div class="modal-content">
            <h3 id="bud-modal-title" style="margin-top:0; text-align:center;">–ù–æ–≤—ã–π –ª–∏–º–∏—Ç</h3>
            <input type="text" id="new-bud-name" class="note-in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥—É–∫—Ç—ã)">
            <input type="number" id="new-bud-val" class="note-in" style="margin-top:10px;" placeholder="–°—É–º–º–∞ –ª–∏–º–∏—Ç–∞">
            <button id="bud-save-btn" class="save-btn" style="margin-top:20px;" onclick="addBudget()">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="bud-del-btn" class="del-btn" style="display:none;" onclick="deleteBudgetReal()">–£–¥–∞–ª–∏—Ç—å –ª–∏–º–∏—Ç</button>
            <button class="note-in" style="margin-top:10px; background:none; color:var(--text);" onclick="closeBudModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="top-bar" id="top-bar">
        <div style="display:flex; gap:15px;">
            <div class="ticker"><span>BTC</span><span id="btc-rate">$...</span></div>
            <div class="ticker"><span>RUB</span><span id="usd-rate">...</span></div>
        </div>
        <div class="sw-box" onclick="document.body.classList.toggle('light');"></div>
    </div>

    <div id="p-home" class="page active">
        <div class="balance-card" onclick="toggleBlur()">
            <div class="bal-container">
                <div class="bal-amount" id="bal">0 ‚ÇΩ</div>
                <svg id="eye-icon" class="eye-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </div>
        </div>

        <div style="display:flex; gap:8px; background:var(--btn-bg); padding:4px; border-radius:12px; margin-bottom:15px;">
            <div id="btn-exp" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer; background:var(--blue);" onclick="setMode('exp')">–†–∞—Å—Ö–æ–¥</div>
            <div id="btn-inc" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer;" onclick="setMode('inc')">–î–æ—Ö–æ–¥</div>
        </div>
        <div class="input-section">
            <input type="number" id="sum" class="sum-in" inputmode="decimal" placeholder="0">
            <input type="text" id="note" class="note-in" placeholder="–ó–∞–º–µ—Ç–∫–∞...">
            <input type="date" id="date-picker" class="date-in">
            <button class="save-btn" onclick="save()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>
        <div class="cat-grid" id="cat-list"></div>
    </div>

    <div id="p-an" class="page">
        <div id="chart-container">
            <div id="chart-slider">
                <div class="chart-slide"><svg width="150" height="150" viewBox="0 0 42 42" id="day-chart"></svg><div style="font-size:12px; font-weight:700; margin-top:10px;">–°–µ–≥–æ–¥–Ω—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div></div>
                <div class="chart-slide"><svg width="300" height="160" id="week-chart"></svg><div style="font-size:12px; font-weight:700; margin-top:5px;">–ù–µ–¥–µ–ª—è</div></div>
                <div class="chart-slide"><svg width="300" height="160" id="month-chart"></svg><div style="font-size:12px; font-weight:700; margin-top:5px;">–ú–µ—Å—è—Ü</div></div>
            </div>
        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
        <div id="h-list-full"></div>
    </div>

    <div id="p-bud" class="page">
        <h2 style="margin: 0 0 20px 0;">–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü</h2>
        <div class="total-budget-card">
            <div style="position:relative; width:120px; height:120px; margin: 0 auto 15px;">
                <svg width="120" height="120" viewBox="0 0 42 42">
                    <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--btn-bg)" stroke-width="3"></circle>
                    <circle id="total-bud-chart" cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--blue)" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="25"></circle>
                </svg>
                <div id="total-bud-perc" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:900; font-size:18px;">0%</div>
            </div>
            <div style="display:flex; justify-content:space-around; font-size:12px;">
                <div><div style="color:var(--text)">–¢–†–ê–¢–´</div><b id="total-bud-spent">0 ‚ÇΩ</b></div>
                <div><div style="color:var(--text)">–õ–ò–ú–ò–¢</div><b id="total-bud-limit">0 ‚ÇΩ</b></div>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 15px;">
            <h3 style="margin:0">–õ–∏–º–∏—Ç—ã</h3>
            <button onclick="openBudModal()" style="background:var(--blue); border:none; color:white; padding:8px 15px; border-radius:12px; font-weight:800;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="budget-list"></div>
    </div>

    <nav class="nav">
        <div class="n-item active" id="n-home" onclick="go('home')"><svg viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1h-5v-7h-4v7H4a1 1 0 01-1-1V9.5z"/></svg>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="n-item" id="n-an" onclick="go('an')"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="n-item" id="n-bud" onclick="go('bud')"><svg viewBox="0 0 24 24"><path d="M9 7h6m-6 4h6m-6 4h6M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>–ë—é–¥–∂–µ—Ç</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const SUPABASE_URL = 'https://ereiiidezagburttpxtn.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_YuQ8s49c1LvkCTmoBPQ0hA_7EJ3Z1cj';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let userId = tg.initDataUnsafe?.user?.id?.toString() || 'user_demo';
        let db = [];
        let budgets = JSON.parse(localStorage.getItem('fin_budgets_' + userId)) || [];
        let mode = 'exp', currentCat = 'üçé', currentSlide = 0, editingId = null, editingBudIdx = null;

        const catColors = { 'üçé':'#ff453a', 'üöó':'#ff9f0a', 'üè†':'#30d158', 'üõçÔ∏è':'#0a84ff', 'üíä':'#bf5af2', 'üéÅ':'#ff375f', 'üé≠':'#64d2ff', 'üì¶':'#a1a1aa', 'üíµ':'#30d158', 'üìà':'#0a84ff' };
        
        const cats = {
            exp: [{n:'–ü—Ä–æ–¥—É–∫—Ç—ã', i:'üçé'}, {n:'–ê–≤—Ç–æ', i:'üöó'}, {n:'–ñ–∏–ª—å–µ', i:'üè†'}, {n:'–®–æ–ø–∏–Ω–≥', i:'üõçÔ∏è'}, {n:'–ê–ø—Ç–µ–∫–∞', i:'üíä'}, {n:'–ü–æ–¥–∞—Ä–∫–∏', i:'üéÅ'}, {n:'–û—Ç–¥—ã—Ö', i:'üé≠'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}],
            inc: [{n:'–ó–∞—Ä–ø–ª–∞—Ç–∞', i:'üíµ'}, {n:'–ò–Ω–≤–µ—Å—Ç', i:'üìà'}, {n:'–ü–æ–¥–∞—Ä–æ–∫', i:'üéÅ'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}]
        };

        // –°–≤–∞–π–ø—ã
        let touchStartX = 0;
        const chartContainer = document.getElementById('chart-container');
        chartContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
        chartContainer.addEventListener('touchend', e => {
            let touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50 && currentSlide < 2) { currentSlide++; drawCharts(); }
            if (touchEndX - touchStartX > 50 && currentSlide > 0) { currentSlide--; drawCharts(); }
        });

        function toDateStr(date) { return date.toISOString().split('T')[0]; }
        function showLoad(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }

        async function syncFromCloud() {
            const local = localStorage.getItem('fin_cache_' + userId);
            if (local) { db = JSON.parse(local); updateUI(); }
            showLoad(true);
            try {
                const { data, error } = await _supabase.from('finance').select('data').eq('id', userId).maybeSingle();
                if (!error && data && data.data) {
                    db = data.data;
                    localStorage.setItem('fin_cache_' + userId, JSON.stringify(db));
                    updateUI();
                }
            } catch (e) {}
            showLoad(false);
        }

        async function cloudSave() {
            localStorage.setItem('fin_cache_' + userId, JSON.stringify(db));
            localStorage.setItem('fin_budgets_' + userId, JSON.stringify(budgets));
            showLoad(true);
            try {
                await _supabase.from('finance').upsert({ id: userId, data: db, updated_at: new Date().toISOString() });
            } catch (e) {}
            showLoad(false);
        }

        // --- –ë–Æ–î–ñ–ï–¢–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        function openBudModal(idx = null) {
            editingBudIdx = idx;
            const modal = document.getElementById('budget-modal');
            const title = document.getElementById('bud-modal-title');
            const btn = document.getElementById('bud-save-btn');
            const delBtn = document.getElementById('bud-del-btn');
            
            if(idx !== null) {
                const b = budgets[idx];
                document.getElementById('new-bud-name').value = b.name;
                document.getElementById('new-bud-val').value = b.limit;
                title.innerText = "–ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç";
                btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
                delBtn.style.display = "block";
            } else {
                document.getElementById('new-bud-name').value = '';
                document.getElementById('new-bud-val').value = '';
                title.innerText = "–ù–æ–≤—ã–π –ª–∏–º–∏—Ç";
                btn.innerText = "–°–æ–∑–¥–∞—Ç—å";
                delBtn.style.display = "none";
            }
            modal.style.display = 'flex';
        }

        function closeBudModal() { 
            document.getElementById('budget-modal').style.display = 'none'; 
            editingBudIdx = null; 
        }
        
        function addBudget() {
            const name = document.getElementById('new-bud-name').value;
            const val = parseFloat(document.getElementById('new-bud-val').value);
            if(name && val) {
                if(editingBudIdx !== null) {
                    budgets[editingBudIdx] = { name, limit: val };
                } else {
                    budgets.push({ name, limit: val });
                }
                cloudSave();
                closeBudModal();
                updateUI();
            }
        }

        function deleteBudgetReal() {
            if(editingBudIdx !== null && confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ª–∏–º–∏—Ç?')) {
                budgets.splice(editingBudIdx, 1);
                cloudSave();
                closeBudModal();
                updateUI();
            }
        }

        function getBudColor(perc) {
            if(perc >= 100) return 'var(--red)';
            if(perc >= 80) return 'var(--orange)';
            return 'var(--blue)';
        }

        function renderBudget() {
            const list = document.getElementById('budget-list');
            const now = new Date();
            const curMonth = now.getMonth();
            let tLimit = 0, tSpent = 0;

            list.innerHTML = budgets.map((b, i) => {
                const spent = db.filter(t => t.t === 'exp' && new Date(t.d).getMonth() === curMonth && (getCatName(t.c).toLowerCase() === b.name.toLowerCase() || t.c === b.name))
                                .reduce((acc, curr) => acc + curr.s, 0);
                tLimit += b.limit; tSpent += spent;
                const perc = Math.min((spent / b.limit) * 100, 100);
                const color = getBudColor((spent/b.limit)*100);

                return `<div class="bud-progress-card" onclick="openBudModal(${i})">
                    <div style="display:flex; justify-content:space-between; font-weight:800; font-size:14px;">
                        <span>${b.name}</span>
                        <span style="color:${color}">${spent.toLocaleString()} / ${b.limit.toLocaleString()} ‚ÇΩ</span>
                    </div>
                    <div class="pg-bar"><div class="pg-fill" style="width:${perc}%; background:${color}"></div></div>
                </div>`;
            }).join('');

            document.getElementById('total-bud-limit').innerText = tLimit.toLocaleString() + ' ‚ÇΩ';
            document.getElementById('total-bud-spent').innerText = tSpent.toLocaleString() + ' ‚ÇΩ';
            const totalPerc = tLimit > 0 ? Math.round((tSpent / tLimit) * 100) : 0;
            document.getElementById('total-bud-perc').innerText = totalPerc + '%';
            document.getElementById('total-bud-chart').setAttribute('stroke-dasharray', `${Math.min(totalPerc, 100)} 100`);
            document.getElementById('total-bud-chart').setAttribute('stroke', getBudColor(totalPerc));
        }

        // --- –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        async function save() {
            const s = document.getElementById('sum'), n = document.getElementById('note'), d = document.getElementById('date-picker');
            if(!s.value || s.value <= 0) return;
            const newRecord = { id: Date.now(), t: mode, c: currentCat, s: parseFloat(s.value), n: n.value || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è', d: d.value || toDateStr(new Date()) };
            db.unshift(newRecord);
            updateUI();
            await cloudSave();
            s.value = ''; n.value = '';
            tg.HapticFeedback.notificationOccurred('success');
        }

        function updateUI() {
            const total = db.reduce((a,i) => a + (i.t === 'inc' ? i.s : -i.s), 0);
            document.getElementById('bal').innerText = total.toLocaleString() + ' ‚ÇΩ';
            renderCats();
            renderHistory();
            renderBudget();
            if(document.getElementById('p-an').classList.contains('active')) drawCharts();
        }

        function renderHistory() {
            const h = document.getElementById('h-list-full');
            if (!h) return;
            h.innerHTML = db.map(i => {
                const p = i.d.split('-');
                const dateFormatted = `${p[2]}.${p[1]}`;
                return `
                    <div class="h-item" onclick="openEdit(${i.id})">
                        <div class="h-left">
                            <div class="h-icon-box" style="color:${catColors[i.c] || 'var(--main)'}">${i.c}</div>
                            <div class="h-details">
                                <div class="h-title-row">
                                    <span class="h-cat-name">${getCatName(i.c)}</span>
                                    <span class="h-date">${dateFormatted}</span>
                                </div>
                                <span class="h-note">${i.n}</span>
                            </div>
                        </div>
                        <div class="h-amount" style="color:${i.t === 'exp' ? 'var(--red)' : 'var(--green)'}">
                            ${i.t === 'exp' ? '-' : '+'}${i.s.toLocaleString()} ‚ÇΩ
                        </div>
                    </div>`;
            }).join('');
        }

        function getCatName(icon) {
            const all = [...cats.exp, ...cats.inc];
            const found = all.find(c => c.i === icon);
            return found ? found.n : '–†–∞–∑–Ω–æ–µ';
        }

        function openEdit(id) {
            editingId = id;
            const item = db.find(x => x.id === id);
            if (!item) return;
            document.getElementById('edit-sum').value = item.s;
            document.getElementById('edit-note').value = item.n;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; editingId = null; }

        async function confirmEdit() {
            const item = db.find(x => x.id === editingId);
            if(item) {
                item.s = parseFloat(document.getElementById('edit-sum').value);
                item.n = document.getElementById('edit-note').value;
                updateUI(); closeModal(); await cloudSave();
            }
        }

        async function deleteTransaction() {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            db = db.filter(x => x.id !== editingId);
            updateUI(); closeModal(); await cloudSave();
        }

        function toggleBlur() { 
            const bal = document.getElementById('bal');
            bal.classList.toggle('blurred');
            tg.HapticFeedback.impactOccurred('light');
        }

        function go(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.n-item').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.getElementById('n-'+p).classList.add('active');
            document.getElementById('top-bar').style.display = (p === 'home') ? 'flex' : 'none';
            updateUI();
        }

        function setMode(m) {
            mode = m; renderCats();
            document.getElementById('btn-exp').style.background = m === 'exp' ? 'var(--blue)' : 'transparent';
            document.getElementById('btn-inc').style.background = m === 'inc' ? 'var(--blue)' : 'transparent';
        }

        function renderCats() {
            const container = document.getElementById('cat-list'); 
            if (!container) return;
            container.innerHTML = '';
            cats[mode].forEach(c => {
                const div = document.createElement('div');
                div.className = `cat-item ${currentCat === c.i ? 'active' : ''}`;
                div.innerHTML = `<div class="cat-icon">${c.i}</div><span class="cat-name">${c.n}</span>`;
                div.onclick = () => { currentCat = c.i; renderCats(); };
                container.appendChild(div);
            });
        }

        function renderDayChart() {
            const chart = document.getElementById('day-chart');
            const today = toDateStr(new Date());
            const todayExp = db.filter(i => i.t === 'exp' && i.d === today);
            const total = todayExp.reduce((a, b) => a + b.s, 0);
            if (total === 0) {
                chart.innerHTML = `<circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--border)" stroke-width="3"/><text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--text)" font-size="3">–ù–µ—Ç —Ç—Ä–∞—Ç</text>`;
                return;
            }
            const catSums = {};
            todayExp.forEach(i => catSums[i.c] = (catSums[i.c] || 0) + i.s);
            let offset = 0, html = '';
            Object.entries(catSums).forEach(([cat, sum]) => {
                const percent = (sum / total) * 100;
                html += `<circle cx="21" cy="21" r="15.9" fill="transparent" stroke="${catColors[cat] || 'var(--blue)'}" stroke-width="5" stroke-dasharray="${percent} ${100 - percent}" stroke-dashoffset="${-offset}" />`;
                offset += percent;
            });
            html += `<text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--main)" font-size="5" font-weight="900">${Math.round(total)}‚ÇΩ</text>`;
            chart.innerHTML = html;
        }

        function renderWeekChart() {
            const svg = document.getElementById('week-chart');
            const daysName = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            const weekSums = new Array(7).fill(0);
            const now = new Date(), currentDayIdx = (now.getDay() + 6) % 7;
            for(let i = 0; i < 7; i++) {
                const d = new Date(now); d.setDate(now.getDate() - currentDayIdx + i);
                const ds = toDateStr(d);
                weekSums[i] = db.filter(item => item.t === 'exp' && item.d === ds).reduce((a, b) => a + b.s, 0);
            }
            const max = Math.max(...weekSums, 100) * 1.3;
            svg.innerHTML = weekSums.map((v, i) => {
                const h = (v / max) * 100, x = 20 + i * 38, y = 130 - h;
                return `<text x="${x + 12}" y="${y - 8}" text-anchor="middle" fill="var(--main)" font-size="8" font-weight="800">${v > 0 ? Math.round(v) : ''}</text>
                        <rect x="${x}" y="${y}" width="24" height="${h}" rx="6" fill="${i === currentDayIdx ? 'var(--blue)' : 'var(--btn-bg)'}"/>
                        <text x="${x + 12}" y="148" text-anchor="middle" fill="var(--text)" font-size="10">${daysName[i]}</text>`;
            }).join('');
        }

        function renderMonthChart() {
            const svg = document.getElementById('month-chart');
            const pointsData = [], now = new Date();
            for(let i = 5; i >= 0; i--) {
                let chunkSum = 0, label = "";
                for(let j = 0; j < 5; j++) {
                    const d = new Date(now); d.setDate(now.getDate() - (i * 5 + j));
                    const ds = toDateStr(d);
                    if (j === 0) label = ds.split('-').slice(2).join('.'); 
                    chunkSum += db.filter(item => item.t === 'exp' && item.d === ds).reduce((a, b) => a + b.s, 0);
                }
                pointsData.push({ label, val: chunkSum });
            }
            const max = Math.max(...pointsData.map(p => p.val), 100) * 1.4;
            const points = pointsData.map((p, i) => ({ x: 30 + i * 48, y: 130 - (p.val / max * 100) }));
            let linePath = `M ${points[0].x} ${points[0].y}`;
            for(let i = 1; i < points.length; i++) linePath += ` L ${points[i].x} ${points[i].y}`;
            svg.innerHTML = `<defs><linearGradient id="mG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--blue)" stop-opacity="0.4"/><stop offset="100%" stop-color="var(--blue)" stop-opacity="0"/></linearGradient></defs>
                <path d="${linePath} L ${points[5].x} 130 L ${points[0].x} 130 Z" fill="url(#mG)" />
                <path d="${linePath}" fill="none" stroke="var(--blue)" stroke-width="3" stroke-linejoin="round"/>
                ${points.map((p, i) => `<text x="${p.x}" y="${p.y - 12}" text-anchor="middle" fill="var(--main)" font-size="8" font-weight="800">${pointsData[i].val > 0 ? Math.round(pointsData[i].val) : ''}</text>
                    <circle cx="${p.x}" cy="${p.y}" r="4" fill="var(--blue)"/><text x="${p.x}" y="148" text-anchor="middle" fill="var(--text)" font-size="9">${pointsData[i].label}</text>`).join('')}`;
        }

        function drawCharts() {
            const slider = document.getElementById('chart-slider');
            if (slider) slider.style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            renderDayChart(); renderWeekChart(); renderMonthChart();
        }

        async function getRates() {
            try {
                const btcR = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const btcD = await btcR.json();
                document.getElementById('btc-rate').innerText = '$' + btcD.bitcoin.usd.toLocaleString();
                const rubR = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const rubD = await rubR.json();
                document.getElementById('usd-rate').innerText = rubD.rates.RUB.toFixed(2) + '‚ÇΩ';
            } catch(e) {}
        }

        window.onload = () => { 
            document.getElementById('date-picker').valueAsDate = new Date();
            tg.expand();
            syncFromCloud();
            getRates(); 
        };
    </script>
</body>
</html>



