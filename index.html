<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #000000; --card: #1c1c1e; --text: #a1a1aa; --main: #ffffff; 
            --blue: #0a84ff; --red: #ff453a; --green: #30d158; --orange: #ff9f0a; --border: rgba(255, 255, 255, 0.1); 
            --btn-bg: #2c2c2e; --glass: rgba(28, 28, 30, 0.85); --grad: linear-gradient(135deg, #2c2c2e 0%, #000000 100%);
            --sw-ball: #ffffff;
        }
        .light { 
            --bg: #f2f2f7; --card: #ffffff; --text: #636366; --main: #000000; 
            --border: rgba(0, 0, 0, 0.08); --btn-bg: #e5e5ea; 
            --glass: rgba(255, 255, 255, 0.85); --grad: linear-gradient(135deg, #ffffff 0%, #f2f2f7 100%);
            --sw-ball: #000000;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--main); margin: 0; min-height: 100vh; overflow-x: hidden; padding-top: env(safe-area-inset-top); }
        .page { display: none; padding: 15px; padding-bottom: 120px; box-sizing: border-box; }
        .active { display: block; }
        .active > *:not(.ai-controls) { animation: slideUp 0.3s ease; }

        .compact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 5px; }
        .ticker-group { display: flex; gap: 15px; }
        .ticker { display: flex; flex-direction: column; }
        .ticker span:first-child { font-size: 8px; font-weight: 800; color: var(--text); text-transform: uppercase; }
        .ticker span:last-child { font-size: 12px; font-weight: 800; color: var(--green); }
        
        .sw-box { width: 44px; height: 24px; background: var(--btn-bg); border-radius: 20px; position: relative; cursor: pointer; border: 1px solid var(--border); }
        .sw-box::after { content: ""; position: absolute; width: 20px; height: 20px; left: 2px; top: 2px; background: var(--sw-ball); border-radius: 50%; transition: 0.25s; }
        .light .sw-box::after { transform: translateX(20px); }

        #edit-modal, #budget-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; 
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content { background: var(--card); border-radius: 28px; padding: 25px; border: 1px solid var(--border); width: 100%; max-width: 400px; }

        #chart-container { position: relative; height: 260px; margin: 10px 0; background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow: hidden; touch-action: pan-y; }
        #chart-slider { display: flex; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); height: 100%; width: 100%; }
        .chart-slide { min-width: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .chart-title { position: absolute; top: 15px; font-size: 10px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 1px; }
        
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: 0.3s; }
        .dot.active { background: var(--blue); transform: scale(1.3); }

        .balance-card { background: var(--grad); border-radius: 24px; padding: 25px 20px; margin-bottom: 15px; border: 1px solid var(--border); text-align: center; position: relative; cursor: pointer; }
        .bal-label { font-size: 11px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .bal-container { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .bal-amount { font-size: 38px; font-weight: 900; transition: filter 0.3s ease; }
        .bal-amount.blurred { filter: blur(12px); }
        .eye-icon { width: 24px; height: 24px; stroke: var(--text); fill: none; stroke-width: 2; }

        .input-section { background: var(--card); border-radius: 24px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .sum-in { width: 100%; background: transparent; border: none; color: var(--main); font-size: 40px; font-weight: 900; text-align: center; outline: none; }
        .note-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 12px; color: var(--main); font-size: 15px; box-sizing: border-box; text-align: center; outline: none; }
        .date-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 10px; color: var(--blue); font-size: 14px; font-weight: 700; text-align: center; box-sizing: border-box; outline: none; }
        .save-btn { background: var(--blue); color: white; border: none; border-radius: 18px; padding: 16px; font-size: 16px; font-weight: 800; width: 100%; cursor:pointer; }
        
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .cat-icon { width: 47px; height: 47px; background: var(--btn-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid transparent; transition: 0.2s; margin: 0 auto; }
        .cat-item.active .cat-icon { border-color: var(--blue); background: var(--blue); }
        .cat-name { font-size: 9px; color: var(--text); font-weight: 600; margin-top: 5px; display: block; text-align: center; text-transform: uppercase; }

        .total-budget-card { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; text-align: center; }
        .bud-progress-card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 10px; border: 1px solid var(--border); }
        .pg-bar { width: 100%; height: 8px; background: var(--btn-bg); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .pg-fill { height: 100%; transition: 0.5s; }

        .h-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card); border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }
        .h-amount { font-weight: 900; font-size: 16px; }

        #ai-chat::-webkit-scrollbar { width: 0; }
        .ai-msg { background: var(--card); padding: 12px; border-radius: 18px 18px 18px 5px; border: 1px solid var(--border); max-width: 85%; font-size: 14px; line-height: 1.4; }
        .user-msg { align-self: flex-end; background: var(--blue); color: white; padding: 12px; border-radius: 18px 18px 5px 18px; max-width: 85%; font-size: 14px; }
        
        /* –ö–ê–¢–ï–ì–û–†–ò–ò –í –õ–ò–ú–ò–¢–ê–• */
        .bud-cat-select { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .bud-cat-item { 
            flex: 0 0 40px; height: 40px; border-radius: 50%; background: var(--btn-bg); 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid transparent; cursor: pointer; font-size: 18px;
        }
        .bud-cat-item.active { border-color: var(--blue); background: var(--blue); }

        .ai-controls { 
            position: fixed; bottom: 75px; left: 15px; right: 15px; 
            display: flex; align-items: center; gap: 10px; 
            background: var(--card); padding: 8px 15px; 
            border-radius: 25px; border: 1px solid var(--border); 
            z-index: 100;
        }
        .mic-btn { 
            background: none; border: none; padding: 5px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .mic-btn svg { width: 20px; height: 20px; stroke: var(--text); fill: none; stroke-width: 2; transition: 0.3s; }
        .mic-btn.active svg { stroke: var(--red); transform: scale(1.2); filter: drop-shadow(0 0 5px var(--red)); }

        .send-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .send-btn svg { width: 20px; height: 20px; stroke: var(--blue); fill: none; stroke-width: 2; transform: rotate(45deg); }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; padding-bottom: env(safe-area-inset-bottom, 15px); z-index: 1000; background: var(--glass); backdrop-filter: blur(20px); border-top: 0.5px solid var(--border); }
        .n-item { flex: 1; text-align: center; padding: 12px 0; color: var(--text); font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .n-item.active { color: var(--blue); }
        .n-item svg { width: 22px; height: 22px; display: block; margin: 0 auto 4px; stroke: currentColor; fill: none; stroke-width: 2.5; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="edit-modal"><div class="modal-content">
        <h3 style="text-align:center;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
        <input type="number" id="edit-sum" class="sum-in">
        <input type="text" id="edit-note" class="note-in" style="margin: 15px 0;">
        <button class="save-btn" onclick="confirmEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="save-btn" style="background:var(--red); margin-top:10px;" onclick="deleteTransaction()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="note-in" style="margin-top:10px; background:none;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div></div>

    <div id="budget-modal"><div class="modal-content">
        <h3 style="text-align:center;">–õ–∏–º–∏—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <div class="bud-cat-select" id="bud-cat-list"></div>
        <input type="text" id="new-bud-name" class="note-in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ï–¥–∞)">
        <input type="number" id="new-bud-val" class="note-in" style="margin-top:10px;" placeholder="–°—É–º–º–∞ –ª–∏–º–∏—Ç–∞">
        <button class="save-btn" style="margin-top:20px;" onclick="addBudget()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="bud-del-btn" class="save-btn" style="background:var(--red); display:none; margin-top:10px;" onclick="deleteBudgetReal()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="note-in" style="margin-top:10px; background:none;" onclick="closeBudModal()">–û—Ç–º–µ–Ω–∞</button>
    </div></div>

    <div id="p-home" class="page active">
        <div class="compact-header">
            <div class="ticker-group">
                <div class="ticker"><span>BTC</span><span id="btc-rate">$...</span></div>
                <div class="ticker"><span>RUB</span><span id="usd-rate">...</span></div>
            </div>
            <div class="sw-box" onclick="document.body.classList.toggle('light');"></div>
        </div>
        <div class="balance-card" onclick="toggleBlur()">
            <span class="bal-label">–ë–∞–ª–∞–Ω—Å</span>
            <div class="bal-container">
                <div class="bal-amount" id="bal">0 ‚ÇΩ</div>
                <svg class="eye-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </div>
        </div>
        <div style="display:flex; gap:8px; background:var(--btn-bg); padding:4px; border-radius:12px; margin-bottom:15px;">
            <div id="btn-exp" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer; background:var(--blue);" onclick="setMode('exp')">–†–∞—Å—Ö–æ–¥</div>
            <div id="btn-inc" style="flex:1; text-align:center; padding:10px; border-radius:10px; font-size:12px; font-weight:800; cursor:pointer;" onclick="setMode('inc')">–î–æ—Ö–æ–¥</div>
        </div>
        <div class="input-section">
            <input type="number" id="sum" class="sum-in" placeholder="0" inputmode="decimal">
            <input type="text" id="note" class="note-in" placeholder="–ó–∞–º–µ—Ç–∫–∞...">
            <input type="date" id="date-picker" class="date-in">
            <button class="save-btn" onclick="save()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>
        <div class="cat-grid" id="cat-list"></div>
    </div>

    <div id="p-an" class="page">
        <div id="chart-container" ontouchstart="tS(event)" ontouchend="tE(event)">
            <div id="chart-slider">
                <div class="chart-slide"><span class="chart-title">–°–µ–≥–æ–¥–Ω—è</span><svg width="200" height="200" viewBox="0 0 42 42" id="day-chart"></svg></div>
                <div class="chart-slide"><span class="chart-title">–ù–µ–¥–µ–ª—è</span><svg width="320" height="180" id="week-chart"></svg></div>
                <div class="chart-slide"><span class="chart-title">–ú–µ—Å—è—Ü</span><svg width="320" height="180" id="month-chart"></svg></div>
            </div>
        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
        <div id="h-list-full"></div>
    </div>

    <div id="p-bud" class="page">
        <div class="total-budget-card">
            <div style="position:relative; width:120px; height:120px; margin: 0 auto 15px;">
                <svg width="120" height="120" viewBox="0 0 42 42">
                    <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--btn-bg)" stroke-width="3"></circle>
                    <circle id="total-bud-chart" cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--blue)" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="25"></circle>
                </svg>
                <div id="total-bud-perc" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:900;">0%</div>
            </div>
            <div style="display:flex; justify-content:space-around; font-size:12px;">
                <div><div style="color:var(--text)">–¢–†–ê–¢–´</div><b id="total-bud-spent">0 ‚ÇΩ</b></div>
                <div><div style="color:var(--text)">–õ–ò–ú–ò–¢</div><b id="total-bud-limit">0 ‚ÇΩ</b></div>
            </div>
        </div>
        <button onclick="openBudModal()" style="width:100%; background:var(--btn-bg); border:none; color:var(--main); padding:15px; border-radius:15px; margin-bottom:20px; font-weight:800;">+ –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
        <div id="budget-list"></div>
    </div>

    <div id="p-ai" class="page">
        <div class="compact-header"><span style="font-weight: 800; color: var(--text);">FINANCE AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span></div>
        <div id="ai-chat" style="height: calc(100vh - 210px); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px;">
            <div class="ai-msg">
    –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ üíº<br><br>
    –Ø –º–æ–≥—É:<br>
    ‚Ä¢ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã<br>
    ‚Ä¢ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–≤–æ–π –±—é–¥–∂–µ—Ç<br>
    ‚Ä¢ –Ω–∞—Ö–æ–¥–∏—Ç—å –ª–∏—à–Ω–∏–µ —Ç—Ä–∞—Ç—ã<br>
    ‚Ä¢ –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ<br><br>
    –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏:<br>
    <b>¬´–¢–∞–∫—Å–∏ 500¬ª</b>, <b>¬´–ó–∞—Ä–ø–ª–∞—Ç–∞ 120000¬ª</b> –∏–ª–∏ <b>¬´–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ —Ç—Ä–∞—Ç—ã¬ª</b>
</div>

        </div>
        <div class="ai-controls">
            <button id="mic-btn" class="mic-btn" onclick="toggleVoice()">
                <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
            </button>
            <input type="text" id="ai-input" style="flex:1; background:none; border:none; color:var(--main); outline:none; font-size:14px;" placeholder="–ì–æ–≤–æ—Ä–∏—Ç–µ...">
            <button class="send-btn" onclick="askAI()">
                <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>

    <nav class="nav">
        <div class="n-item active" onclick="go('home')"><svg viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1h-5v-7h-4v7H4a1 1 0 01-1-1V9.5z"/></svg>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="n-item" onclick="go('an')"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="n-item" onclick="go('bud')"><svg viewBox="0 0 24 24"><path d="M9 7h6m-6 4h6m-6 4h6M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>–ë—é–¥–∂–µ—Ç</div>
        <div class="n-item" onclick="go('ai')"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 00-7.74 16.33l-1.13 3.38a1 1 0 001.26 1.26l3.38-1.13A10 10 0 1012 2z"/></svg>AI</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const { createClient } = supabase;
        const _supabase = createClient('https://ereiiidezagburttpxtn.supabase.co', 'sb_publishable_YuQ8s49c1LvkCTmoBPQ0hA_7EJ3Z1cj');
        
        let userId = tg.initDataUnsafe?.user?.id?.toString() || 'user_demo';
        let db = [];
        let budgets = JSON.parse(localStorage.getItem('fin_budgets_' + userId)) || [];
        let mode = 'exp', currentCat = 'üõí', currentSlide = 0, touchStartX = 0, editingBudIdx = null, editingId = null;
        let budSelectedCat = 'üõí';
        let isListening = false;

        const catColors = { 'üõí':'#ff453a', 'üöó':'#ff9f0a', 'üè†':'#30d158', 'üõçÔ∏è':'#0a84ff', 'üíä':'#bf5af2', 'üéÅ':'#ff375f', 'üé≠':'#64d2ff', 'üì¶':'#a1a1aa', 'üíµ':'#30d158', 'üìà':'#0a84ff' };
        const cats = {
            exp: [{n:'–ü—Ä–æ–¥—É–∫—Ç—ã', i:'üõí'}, {n:'–ê–≤—Ç–æ', i:'üöó'}, {n:'–ñ–∏–ª—å–µ', i:'üè†'}, {n:'–®–æ–ø–∏–Ω–≥', i:'üõçÔ∏è'}, {n:'–ê–ø—Ç–µ–∫–∞', i:'üíä'}, {n:'–ü–æ–¥–∞—Ä–∫–∏', i:'üéÅ'}, {n:'–û—Ç–¥—ã—Ö', i:'üé≠'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}],
            inc: [{n:'–ó–∞—Ä–ø–ª–∞—Ç–∞', i:'üíµ'}, {n:'–ò–Ω–≤–µ—Å—Ç', i:'üìà'}, {n:'–ü–æ–¥–∞—Ä–æ–∫', i:'üéÅ'}, {n:'–ü—Ä–æ—á–µ–µ', i:'üì¶'}]
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false; 
            recognition.onstart = () => { isListening = true; document.getElementById('mic-btn').classList.add('active'); tg.HapticFeedback.impactOccurred('medium'); };
            recognition.onend = () => { isListening = false; document.getElementById('mic-btn').classList.remove('active'); };
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                if (text.trim().length > 0) { document.getElementById('ai-input').value = text; askAI(); }
            };
        }

        function toggleVoice() { if (!recognition) return alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); if (isListening) recognition.stop(); else recognition.start(); }

        function go(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.n-item').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            const idx = ['home', 'an', 'bud', 'ai'].indexOf(p);
            document.querySelectorAll('.n-item')[idx].classList.add('active');
            updateUI();
        }

        async function syncFromCloud() {
            const local = localStorage.getItem('fin_cache_' + userId);
            if (local) { db = JSON.parse(local); updateUI(); }
            try {
                const { data } = await _supabase.from('finance').select('data').eq('id', userId).maybeSingle();
                if (data?.data) { db = data.data; updateUI(); }
            } catch(e) {}
        }

        async function cloudSave() {
            localStorage.setItem('fin_cache_' + userId, JSON.stringify(db));
            localStorage.setItem('fin_budgets_' + userId, JSON.stringify(budgets));
            await _supabase.from('finance').upsert({ id: userId, data: db, updated_at: new Date().toISOString() });
        }

        function updateUI() {
            const total = db.reduce((a,i) => a + (i.t === 'inc' ? i.s : -i.s), 0);
            document.getElementById('bal').innerText = total.toLocaleString() + ' ‚ÇΩ';
            renderCats(); renderHistory(); renderBudget();
            if(document.getElementById('p-an').classList.contains('active')) drawCharts();
        }

        function renderCats() {
            document.getElementById('cat-list').innerHTML = cats[mode].map(c => `<div class="cat-item ${currentCat === c.i ? 'active' : ''}" onclick="currentCat='${c.i}'; renderCats();"><div class="cat-icon">${c.i}</div><span class="cat-name">${c.n}</span></div>`).join('');
        }

        function renderBudCatList() {
            document.getElementById('bud-cat-list').innerHTML = cats.exp.map(c => `
                <div class="bud-cat-item ${budSelectedCat === c.i ? 'active' : ''}" onclick="budSelectedCat='${c.i}'; renderBudCatList();">
                    ${c.i}
                </div>`).join('');
        }

        async function save() {
            const s = document.getElementById('sum'), n = document.getElementById('note'), d = document.getElementById('date-picker');
            if(!s.value) return;
            db.unshift({ id: Date.now(), t: mode, c: currentCat, s: parseFloat(s.value), n: n.value || '–ó–∞–ø–∏—Å—å', d: d.value });
            updateUI(); await cloudSave(); s.value = ''; n.value = ''; tg.HapticFeedback.notificationOccurred('success');
        }

        function renderBudget() {
            const list = document.getElementById('budget-list');
            const curMonth = new Date().toISOString().slice(0, 7);
            let tLimit = 0, tSpent = 0;

            list.innerHTML = budgets.map((b, i) => {
                // –°–í–Ø–ó–¨: –°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã —Ç–æ–ª—å–∫–æ –ø–æ –∏–∫–æ–Ω–∫–µ —ç—Ç–æ–≥–æ –ª–∏–º–∏—Ç–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
                const spent = db.filter(t => t.t === 'exp' && t.c === b.cat && t.d.startsWith(curMonth)).reduce((a,c)=>a+c.s, 0);
                tLimit += b.limit; tSpent += spent; 
                const perc = Math.min((spent/b.limit)*100, 100);
                return `<div class="bud-progress-card" onclick="openBudModal(${i})">
                            <div style="display:flex; justify-content:space-between; font-size:14px;">
                                <b>${b.cat} ${b.name}</b>
                                <span>${spent.toLocaleString()} / ${b.limit.toLocaleString()} ‚ÇΩ</span>
                            </div>
                            <div class="pg-bar"><div class="pg-fill" style="width:${perc}%; background:${perc > 90 ? 'var(--red)' : 'var(--blue)'}"></div></div>
                        </div>`;
            }).join('');

            document.getElementById('total-bud-limit').innerText = tLimit.toLocaleString() + ' ‚ÇΩ';
            document.getElementById('total-bud-spent').innerText = tSpent.toLocaleString() + ' ‚ÇΩ';
            const totalPerc = tLimit > 0 ? Math.round((tSpent/tLimit)*100) : 0;
            document.getElementById('total-bud-perc').innerText = totalPerc + '%';
            document.getElementById('total-bud-chart').style.strokeDasharray = `${Math.min(totalPerc, 100)} 100`;
        }

        function openBudModal(idx = null) { 
            editingBudIdx = idx; 
            if(idx !== null) { 
                document.getElementById('new-bud-name').value = budgets[idx].name; 
                document.getElementById('new-bud-val').value = budgets[idx].limit; 
                budSelectedCat = budgets[idx].cat || 'üõí';
                document.getElementById('bud-del-btn').style.display = 'block'; 
            } else { 
                document.getElementById('new-bud-name').value = ''; 
                document.getElementById('new-bud-val').value = ''; 
                document.getElementById('bud-del-btn').style.display = 'none'; 
            } 
            renderBudCatList();
            document.getElementById('budget-modal').style.display = 'flex'; 
        }

        function closeBudModal() { document.getElementById('budget-modal').style.display = 'none'; }
        
        function addBudget() { 
            const n = document.getElementById('new-bud-name').value, v = parseFloat(document.getElementById('new-bud-val').value); 
            if(!n || isNaN(v)) return;
            const data = {name: n, limit: v, cat: budSelectedCat};
            if(editingBudIdx !== null) budgets[editingBudIdx] = data; else budgets.push(data); 
            closeBudModal(); updateUI(); cloudSave(); 
        }

        function deleteBudgetReal() { budgets.splice(editingBudIdx, 1); closeBudModal(); updateUI(); cloudSave(); }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function renderDayChart() {
            const chart = document.getElementById('day-chart');
            const today = new Date().toISOString().split('T')[0];
            const todayExp = db.filter(i => i.t === 'exp' && i.d === today);
            const total = todayExp.reduce((a, b) => a + b.s, 0);
            if (total === 0) { chart.innerHTML = `<circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--border)" stroke-width="3"/><text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--text)" font-size="4">0 ‚ÇΩ</text>`; return; }
            const catSums = {}; todayExp.forEach(i => catSums[i.c] = (catSums[i.c] || 0) + i.s);
            let offset = 0, html = '';
            Object.entries(catSums).forEach(([cat, sum]) => {
                const percent = (sum / total) * 100;
                html += `<circle cx="21" cy="21" r="15.9" fill="transparent" stroke="${catColors[cat] || 'var(--blue)'}" stroke-width="5" stroke-dasharray="${percent} ${100 - percent}" stroke-dashoffset="${-offset}" />`;
                offset += percent;
            });
            html += `<text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--main)" font-size="5" font-weight="900">${Math.round(total)} ‚ÇΩ</text>`;
            chart.innerHTML = html;
        }

        function renderWeekChart() {
            const svg = document.getElementById('week-chart');
            const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            const weekSums = new Array(7).fill(0);
            const now = new Date();
            const currentDayIdx = now.getDay() === 0 ? 6 : now.getDay() - 1;
            const monday = new Date(now); monday.setDate(now.getDate() - currentDayIdx);
            for(let i=0; i<7; i++) {
                const d = new Date(monday); d.setDate(monday.getDate() + i);
                const ds = d.toISOString().split('T')[0];
                weekSums[i] = db.filter(item => item.t === 'exp' && item.d === ds).reduce((a, b) => a + b.s, 0);
            }
            const max = Math.max(...weekSums, 1000) * 1.3;
            svg.innerHTML = weekSums.map((v, i) => {
                const h = (v/max)*120; const x = 30 + i*40; const y = 140-h;
                return `<text x="${x+10}" y="${y-8}" text-anchor="middle" fill="var(--main)" font-size="7">${v > 0 ? Math.round(v) : ''}</text>
                        <rect x="${x}" y="${y}" width="20" height="${h}" rx="6" fill="${i === currentDayIdx ? 'var(--blue)' : 'var(--btn-bg)'}"/>
                        <text x="${x+10}" y="160" text-anchor="middle" fill="var(--text)" font-size="9">${days[i]}</text>`;
            }).join('');
        }

       function renderMonthChart() {
    const svg = document.getElementById('month-chart');
    const pointsCount = 6; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    const daysPerBlock = 5; // –®–∞–≥ (5 –¥–Ω–µ–π)
    const sums = new Array(pointsCount).fill(0);
    const labels = new Array(pointsCount).fill('');
    
    // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ (–∫–æ–Ω–µ—Ü –≥—Ä–∞—Ñ–∏–∫–∞)
    const now = new Date();
    now.setHours(23, 59, 59, 999);

    // 1. –ü—Ä–æ—Ö–æ–¥–∏–º —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ (i=0 ‚Äî —ç—Ç–æ —Å–∞–º–∞—è —Å—Ç–∞—Ä–∞—è —Ç–æ—á–∫–∞, i=5 ‚Äî —Å–µ–≥–æ–¥–Ω—è)
    for(let i = 0; i < pointsCount; i++) {
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ –≤ –ø—Ä–æ—à–ª–æ–º —ç—Ç–∞ —Ç–æ—á–∫–∞
        // –ï—Å–ª–∏ i=0 (–ª–µ–≤–æ), offset=5 (25 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
        // –ï—Å–ª–∏ i=5 (–ø—Ä–∞–≤–æ), offset=0 (0 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
        const offset = pointsCount - 1 - i; 

        const minDaysAgo = offset * daysPerBlock;       
        const maxDaysAgo = (offset + 1) * daysPerBlock; 

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –¥–∞—Ç—É –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "25.05")
        const labelDate = new Date();
        labelDate.setDate(now.getDate() - minDaysAgo);
        const day = String(labelDate.getDate()).padStart(2, '0');
        const month = String(labelDate.getMonth() + 1).padStart(2, '0');
        labels[i] = `${day}.${month}`;

        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å—É–º–º–∏—Ä—É–µ–º —Ç—Ä–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        sums[i] = db.filter(item => {
            if (item.t !== 'exp') return false;
            
            const itemDate = new Date(item.d);
            const diffTime = now - itemDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            // –ë–µ—Ä–µ–º —Ç—Ä–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
            return diffDays >= minDaysAgo && diffDays < maxDaysAgo;
        }).reduce((a, b) => a + b.s, 0);
    }

    // 2. –ú–∞—Å—à—Ç–∞–± –≥—Ä–∞—Ñ–∏–∫–∞
    const max = Math.max(...sums, 1000) * 1.3;

    // 3. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫
    const points = sums.map((v, i) => ({ 
        x: 40 + i * 48, 
        y: 140 - (v / max) * 100 
    }));

    // 4. –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏
    const linePath = points.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ');
    const areaPath = linePath + ` L${points[points.length-1].x},140 L${points[0].x},140 Z`;

    // 5. –í—ã–≤–æ–¥–∏–º SVG
    svg.innerHTML = `
        <defs>
            <linearGradient id="gm" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="var(--blue)" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="transparent"/>
            </linearGradient>
        </defs>
        
        <path d="${areaPath}" fill="url(#gm)" />
        
        <path d="${linePath}" fill="none" stroke="var(--blue)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        
        ${points.map((p, i) => {
            // –°—É–º–º–∞ –Ω–∞–¥ —Ç–æ—á–∫–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–∞—Ç—ã)
            const valLabel = sums[i] > 0 ? Math.round(sums[i]) : '';
            
            return `
            <circle cx="${p.x}" cy="${p.y}" r="4" fill="var(--card)" stroke="var(--blue)" stroke-width="2"/>
            
            <text x="${p.x}" y="${p.y-12}" text-anchor="middle" fill="var(--main)" font-size="8" font-weight="900">${valLabel}</text>
            
            <text x="${p.x}" y="165" text-anchor="middle" fill="var(--text)" font-size="8">${labels[i]}</text>
            `;
        }).join('')}
    `;
}

        function drawCharts() {
            document.getElementById('chart-slider').style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            if(currentSlide === 0) renderDayChart();
            if(currentSlide === 1) renderWeekChart();
            if(currentSlide === 2) renderMonthChart();
        }

        function tS(e) { touchStartX = e.changedTouches[0].screenX; }
        function tE(e) {
            let x = e.changedTouches[0].screenX;
            if (touchStartX - x > 50 && currentSlide < 2) currentSlide++;
            if (x - touchStartX > 50 && currentSlide > 0) currentSlide--;
            drawCharts();
        }

        function renderHistory() {
            document.getElementById('h-list-full').innerHTML = db.map(i => `<div class="h-item" onclick="openEdit(${i.id})"><div><span style="font-size:18px; margin-right:8px;">${i.c}</span><b>${i.n}</b><br><small style="color:var(--text)">${i.d}</small></div><div class="h-amount" style="color:${i.t==='exp'?'var(--red)':'var(--green)'}">${i.s.toLocaleString()} ‚ÇΩ</div></div>`).join('');
        }

async function askAI() {
    const input = document.getElementById('ai-input');
    const chat = document.getElementById('ai-chat');
    const q = input.value.trim();
    if (!q) return;

    chat.innerHTML += `<div class="user-msg">${q}</div>`;
    input.value = '';

    const tempId = 'ai-' + Date.now();
    chat.innerHTML += `<div id="${tempId}" class="ai-msg">üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã...</div>`;
    chat.scrollTop = chat.scrollHeight;

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: q,
                history: db   // üî• –ü–ï–†–ï–î–ê–Å–ú –í–°–Æ –ò–°–¢–û–†–ò–Æ
            })
        });

        const raw = await response.json();
        const content = raw?.choices?.[0]?.message?.content || "";
        const jsonMatch = content.match(/\{[\s\S]*\}/);

        if (!jsonMatch) {
            document.getElementById(tempId).innerText = content || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
            return;
        }

        const ai = JSON.parse(jsonMatch[0]);

        // === –ê–í–¢–û–ó–ê–ü–ò–°–¨ ===
        if (ai.action === 'add') {
            const catMap = {
                –ø—Ä–æ–¥—É–∫—Ç—ã: "üõí",
                –∞–≤—Ç–æ: "üöó",
                –∂–∏–ª—å—ë: "üè†",
                —à–æ–ø–∏–Ω–≥: "üõçÔ∏è",
                –∞–ø—Ç–µ–∫–∞: "üíä",
                –ø–æ–¥–∞—Ä–∫–∏: "üéÅ",
                –æ—Ç–¥—ã—Ö: "üé≠",
                –ø—Ä–æ—á–µ–µ: "üì¶"
            };

            const entry = {
                id: Date.now(),
                t: ai.type,
                c: catMap[ai.category] || "üì¶",
                s: Number(ai.amount),
                n: ai.note || '',
                d: new Date().toISOString().split('T')[0]
            };

            db.unshift(entry);
            updateUI();
            await cloudSave();

            document.getElementById(tempId).innerHTML = `
                ‚úÖ <b>–ó–∞–ø–∏—Å–∞–Ω–æ</b><br>
                ${entry.c} ${entry.s} ‚ÇΩ ‚Äî ${entry.n}
            `;
        }

        // === –ê–ù–ê–õ–ò–ó ===
        else if (ai.action === 'analysis') {
            document.getElementById(tempId).innerText = ai.text;
        }

    } catch (e) {
        console.error(e);
        document.getElementById(tempId).innerText = '‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å AI';
    }

    chat.scrollTop = chat.scrollHeight;
}
        
        window.quickAdd = async (t, c, s, n) => {
            db.unshift({ id: Date.now(), t, c, s, n, d: new Date().toISOString().split('T')[0] });
            updateUI(); await cloudSave(); go('home');
        };

        function setMode(m) { mode = m; currentCat = cats[m][0].i; renderCats(); document.getElementById('btn-exp').style.background = m === 'exp' ? 'var(--blue)' : 'transparent'; document.getElementById('btn-inc').style.background = m === 'inc' ? 'var(--blue)' : 'transparent'; }
        function toggleBlur() { document.getElementById('bal').classList.toggle('blurred'); tg.HapticFeedback.impactOccurred('light'); }
        function openEdit(id) { editingId = id; const item = db.find(x => x.id === id); document.getElementById('edit-sum').value = item.s; document.getElementById('edit-note').value = item.n; document.getElementById('edit-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function confirmEdit() { const item = db.find(x => x.id === editingId); item.s = parseFloat(document.getElementById('edit-sum').value); item.n = document.getElementById('edit-note').value; updateUI(); closeModal(); await cloudSave(); }
        async function deleteTransaction() { db = db.filter(x => x.id !== editingId); updateUI(); closeModal(); await cloudSave(); }

        async function getRates() {
            try {
                const btc = await (await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')).json();
                document.getElementById('btc-rate').innerText = '$' + btc.bitcoin.usd.toLocaleString();
                const rub = await (await fetch('https://api.exchangerate-api.com/v4/latest/USD')).json();
                document.getElementById('usd-rate').innerText = rub.rates.RUB.toFixed(2) + '‚ÇΩ';
            } catch(e) {}
        }

        window.onload = () => { 
            document.getElementById('date-picker').value = new Date().toISOString().split('T')[0];
            tg.expand(); syncFromCloud(); getRates(); 
        };
    </script>
</body>
</html>

























