<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #000000; --card: #1c1c1e; --text: #a1a1aa; --main: #ffffff; 
            --blue: #0a84ff; --red: #ff453a; --green: #30d158; --orange: #ff9f0a; --border: rgba(255, 255, 255, 0.1); 
            --btn-bg: #2c2c2e; --glass: rgba(28, 28, 30, 0.85); --grad: linear-gradient(135deg, #2c2c2e 0%, #000000 100%);
            --sw-ball: #ffffff;
        }
        .light { 
            --bg: #f2f2f7; --card: #ffffff; --text: #636366; --main: #000000; 
            --border: rgba(0, 0, 0, 0.08); --btn-bg: #e5e5ea; 
            --glass: rgba(255, 255, 255, 0.85); --grad: linear-gradient(135deg, #ffffff 0%, #f2f2f7 100%);
            --sw-ball: #000000;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--main); margin: 0; min-height: 100vh; overflow-x: hidden; padding-top: env(safe-area-inset-top); }
        .page { display: none; padding: 15px; padding-bottom: 120px; box-sizing: border-box; }
        .active { display: block; }
        .active > *:not(.ai-controls) { animation: slideUp 0.3s ease; }

        /* –®–∞–ø–∫–∞ –∏ —Ç–∏–∫–µ—Ä—ã */
        .compact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 5px; }
        .ticker-group { display: flex; gap: 15px; }
        .ticker { display: flex; flex-direction: column; }
        .ticker span:first-child { font-size: 8px; font-weight: 800; color: var(--text); text-transform: uppercase; }
        .ticker span:last-child { font-size: 12px; font-weight: 800; color: var(--green); }
        
        .sw-box { width: 44px; height: 24px; background: var(--btn-bg); border-radius: 20px; position: relative; cursor: pointer; border: 1px solid var(--border); }
        .sw-box::after { content: ""; position: absolute; width: 20px; height: 20px; left: 2px; top: 2px; background: var(--sw-ball); border-radius: 50%; transition: 0.25s; }
        .light .sw-box::after { transform: translateX(20px); }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ */
        #chart-container { position: relative; height: 260px; margin: 10px 0; background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow: hidden; touch-action: pan-y; }
        #chart-slider { display: flex; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); height: 100%; width: 100%; }
        .chart-slide { min-width: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .chart-title { position: absolute; top: 15px; font-size: 10px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 1px; }
        
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: 0.3s; }
        .dot.active { background: var(--blue); transform: scale(1.3); }

        /* –ë–∞–ª–∞–Ω—Å –∏ –∏–Ω–ø—É—Ç—ã */
        .balance-card { background: var(--grad); border-radius: 24px; padding: 25px 20px; margin-bottom: 15px; border: 1px solid var(--border); text-align: center; cursor: pointer; }
        .bal-amount { font-size: 38px; font-weight: 900; transition: filter 0.3s ease; }
        .bal-amount.blurred { filter: blur(12px); }
        
        .input-section { background: var(--card); border-radius: 24px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .sum-in { width: 100%; background: transparent; border: none; color: var(--main); font-size: 40px; font-weight: 900; text-align: center; outline: none; }
        .note-in { width: 100%; background: var(--btn-bg); border: none; border-radius: 12px; padding: 12px; color: var(--main); font-size: 15px; text-align: center; outline: none; box-sizing: border-box; }
        .save-btn { background: var(--blue); color: white; border: none; border-radius: 18px; padding: 16px; font-size: 16px; font-weight: 800; width: 100%; cursor:pointer; }
        
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .cat-icon { width: 47px; height: 47px; background: var(--btn-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid transparent; margin: 0 auto; }
        .cat-item.active .cat-icon { border-color: var(--blue); background: var(--blue); }
        .cat-name { font-size: 9px; color: var(--text); font-weight: 600; margin-top: 5px; display: block; text-align: center; text-transform: uppercase; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .h-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card); border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }

        /* AI –ü–∞–Ω–µ–ª—å */
        .ai-controls { 
            position: fixed; bottom: 75px; left: 15px; right: 15px; display: flex; align-items: center; gap: 5px; 
            background: var(--card); padding: 4px 8px; border-radius: 20px; border: 1px solid var(--border); z-index: 100;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; display: flex; padding-bottom: env(safe-area-inset-bottom, 15px); z-index: 1000; background: var(--glass); backdrop-filter: blur(20px); border-top: 0.5px solid var(--border); }
        .n-item { flex: 1; text-align: center; padding: 12px 0; color: var(--text); font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .n-item.active { color: var(--blue); }
        .n-item svg { width: 22px; height: 22px; display: block; margin: 0 auto 4px; stroke: currentColor; fill: none; stroke-width: 2.5; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:var(--card); padding:25px; border-radius:28px; width:80%;">
            <input type="number" id="edit-sum" class="sum-in">
            <button class="save-btn" onclick="confirmEdit()">–û–∫</button>
            <button class="note-in" style="margin-top:10px; background:none;" onclick="document.getElementById('edit-modal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="p-home" class="page active">
        <div class="compact-header">
            <div class="ticker-group">
                <div class="ticker"><span>BTC</span><span id="btc-rate">$...</span></div>
                <div class="ticker"><span>RUB</span><span id="usd-rate">...</span></div>
            </div>
            <div class="sw-box" onclick="document.body.classList.toggle('light');"></div>
        </div>
        <div class="balance-card" onclick="document.getElementById('bal').classList.toggle('blurred')">
            <div class="bal-amount" id="bal">0 ‚ÇΩ</div>
        </div>
        <div class="input-section">
            <input type="number" id="sum" class="sum-in" placeholder="0" inputmode="decimal">
            <input type="text" id="note" class="note-in" placeholder="–ó–∞–º–µ—Ç–∫–∞...">
            <button class="save-btn" onclick="save()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="cat-grid" id="cat-list"></div>
    </div>

    <div id="p-an" class="page">
        <div id="chart-container" ontouchstart="tS(event)" ontouchend="tE(event)">
            <div id="chart-slider">
                <div class="chart-slide"><span class="chart-title">–°–µ–≥–æ–¥–Ω—è</span><svg width="200" height="200" viewBox="0 0 42 42" id="day-chart"></svg></div>
                <div class="chart-slide"><span class="chart-title">–ù–µ–¥–µ–ª—è</span><svg width="320" height="180" id="week-chart"></svg></div>
                <div class="chart-slide">
                    <span class="chart-title">–ú–µ—Å—è—Ü</span>
                    <svg width="320" height="180" id="month-chart"></svg>
                </div>
            </div>
        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
        <div id="h-list-full"></div>
    </div>

    <div id="p-bud" class="page">
        <div id="budget-list"></div>
    </div>

    <div id="p-ai" class="page">
        <div id="ai-chat" style="height: calc(100vh - 210px); overflow-y: auto; padding-bottom: 80px;"></div>
        <div class="ai-controls">
            <input type="text" id="ai-input" style="flex:1; background:none; border:none; color:var(--main); outline:none;" placeholder="–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è...">
            <button class="save-btn" style="width:auto; padding:8px 15px;" onclick="askAI()">></button>
        </div>
    </div>

    <nav class="nav">
        <div class="n-item active" id="n-home" onclick="go('home')"><svg viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1h-5v-7h-4v7H4a1 1 0 01-1-1V9.5z"/></svg>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="n-item" id="n-an" onclick="go('an')"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="n-item" id="n-bud" onclick="go('bud')"><svg viewBox="0 0 24 24"><path d="M9 7h6m-6 4h6m-6 4h6M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>–ë—é–¥–∂–µ—Ç</div>
        <div class="n-item" id="n-ai" onclick="go('ai')"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 00-7.74 16.33l-1.13 3.38a1 1 0 001.26 1.26l3.38-1.13A10 10 0 1012 2z"/></svg>AI</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        let db = JSON.parse(localStorage.getItem('fin_cache_v2')) || [];
        let currentSlide = 0, touchStartX = 0, currentCat = 'üõí';

        const catColors = { 'üõí':'#ff453a', 'üöó':'#ff9f0a', 'üè†':'#30d158', 'üõçÔ∏è':'#0a84ff', 'üì¶':'#a1a1aa' };

        function go(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.n-item').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.getElementById('n-'+p).classList.add('active');
            updateUI();
        }

        function tS(e) { touchStartX = e.changedTouches[0].screenX; }
        function tE(e) {
            let x = e.changedTouches[0].screenX;
            if (touchStartX - x > 50 && currentSlide < 2) currentSlide++;
            if (x - touchStartX > 50 && currentSlide > 0) currentSlide--;
            drawCharts();
        }

        // --- –†–ï–ú–û–ù–¢ –¢–†–ï–¢–¨–ï–ì–û –ì–†–ê–§–ò–ö–ê (–ú–ï–°–Ø–¶) ---
        function renderMonthChart() {
            const svg = document.getElementById('month-chart');
            const pointsCount = 6;
            const sums = new Array(pointsCount).fill(0);
            const now = new Date();
            
            for(let i=0; i<pointsCount; i++) {
                const dayLimit = (i + 1) * 5;
                sums[i] = db.filter(item => (now - new Date(item.d)) / 86400000 <= dayLimit).reduce((a, b) => a + b.s, 0);
            }
            
            const max = Math.max(...sums, 100) * 1.4;
            const pts = sums.map((v, i) => ({ x: 40 + i * 48, y: 140 - (v / max) * 100 }));
            
            const linePath = pts.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ');
            const areaPath = linePath + ` L${pts[pts.length-1].x},140 L${pts[0].x},140 Z`;

            svg.innerHTML = `
                <defs>
                    <linearGradient id="g-blue" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#0a84ff" stop-opacity="0.4"/>
                        <stop offset="100%" stop-color="#0a84ff" stop-opacity="0"/>
                    </linearGradient>
                </defs>
                <path d="${areaPath}" fill="url(#g-blue)" />
                <path d="${linePath}" fill="none" stroke="#0a84ff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                ${pts.map((p, i) => `
                    <circle cx="${p.x}" cy="${p.y}" r="4" fill="#0a84ff" stroke="#000" stroke-width="1" />
                    <text x="${p.x}" y="${p.y - 10}" text-anchor="middle" fill="var(--main)" font-size="8" font-weight="900">${sums[i] > 0 ? Math.round(sums[i]) : ''}</text>
                    <text x="${p.x}" y="160" text-anchor="middle" fill="var(--text)" font-size="8" font-weight="800">${(i+1)*5}–¥</text>
                `).join('')}
            `;
        }

        // --- –û–°–¢–ê–õ–¨–ù–´–ï –ì–†–ê–§–ò–ö–ò ---
        function renderDayChart() {
            const chart = document.getElementById('day-chart');
            const total = db.reduce((a,b)=>a+b.s, 0);
            if(total === 0) { chart.innerHTML = '<circle cx="21" cy="21" r="15.9" stroke="var(--border)" fill="none" stroke-width="3"/><text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--text)" font-size="4">0 ‚ÇΩ</text>'; return; }
            chart.innerHTML = `<circle cx="21" cy="21" r="15.9" stroke="var(--blue)" fill="none" stroke-width="5" stroke-dasharray="100 0"/><text x="21" y="21" text-anchor="middle" dy=".3em" fill="var(--main)" font-size="5" font-weight="900">${total} ‚ÇΩ</text>`;
        }

        function renderWeekChart() {
            const svg = document.getElementById('week-chart');
            svg.innerHTML = `<text x="160" y="90" text-anchor="middle" fill="var(--text)">–î–∞–Ω–Ω—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é</text>`;
        }

        function drawCharts() {
            document.getElementById('chart-slider').style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            if(currentSlide === 0) renderDayChart();
            if(currentSlide === 1) renderWeekChart();
            if(currentSlide === 2) renderMonthChart();
        }

        function updateUI() {
            const total = db.reduce((a,i) => a + i.s, 0);
            document.getElementById('bal').innerText = total.toLocaleString() + ' ‚ÇΩ';
            document.getElementById('cat-list').innerHTML = ['üõí','üöó','üè†','üõçÔ∏è','üì¶'].map(c => `<div class="cat-item ${currentCat===c?'active':''}" onclick="currentCat='${c}'; updateUI()"><div class="cat-icon">${c}</div></div>`).join('');
            document.getElementById('h-list-full').innerHTML = db.slice(0,10).map(i => `<div class="h-item"><span>${i.c} ${i.n}</span><b>${i.s} ‚ÇΩ</b></div>`).join('');
            if(document.getElementById('p-an').classList.contains('active')) drawCharts();
        }

        function save() {
            const s = document.getElementById('sum'), n = document.getElementById('note');
            if(!s.value) return;
            db.unshift({ s: parseFloat(s.value), n: n.value || '–ó–∞–ø–∏—Å—å', d: new Date().toISOString(), c: currentCat });
            localStorage.setItem('fin_cache_v2', JSON.stringify(db));
            s.value = ''; n.value = ''; updateUI();
            tg.HapticFeedback.notificationOccurred('success');
        }

        async function getRates() {
            try {
                const btc = await (await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')).json();
                document.getElementById('btc-rate').innerText = '$' + btc.bitcoin.usd.toLocaleString();
            } catch(e) {}
        }

        window.onload = () => { tg.expand(); getRates(); updateUI(); };
    </script>
</body>
</html>











